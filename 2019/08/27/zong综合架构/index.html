<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.ico?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.ico?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="架构,">










<meta name="description" content="综合架构服务器配制方法">
<meta name="keywords" content="架构">
<meta property="og:type" content="article">
<meta property="og:title" content="综合架构">
<meta property="og:url" content="https://gry.github.io/2019/08/27/zong综合架构/index.html">
<meta property="og:site_name" content="GRY的博客">
<meta property="og:description" content="综合架构服务器配制方法">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://gry.github.io/images/zong%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/1560587760671.png">
<meta property="og:image" content="https://gry.github.io/images/zong%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/1560587803162.png">
<meta property="og:image" content="https://gry.github.io/images/zong%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/1560587893342.png">
<meta property="og:image" content="https://gry.github.io/2019/08/27/zong综合架构/%5CUsers%5CAdministrator%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5C3.png">
<meta property="og:image" content="https://gry.github.io/images/zong%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/1561191549174.png">
<meta property="og:image" content="https://gry.github.io/images/zong%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/1561191568297.png">
<meta property="og:image" content="https://gry.github.io/images/zong%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/1561191623567.png">
<meta property="og:image" content="https://gry.github.io/images/zong%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/1561191651334.png">
<meta property="og:image" content="https://gry.github.io/images/zong%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/1561191661913.png">
<meta property="og:image" content="https://gry.github.io/images/zong%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/1561191682898.png">
<meta property="og:image" content="https://gry.github.io/images/zong%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/1561191737865.png">
<meta property="og:image" content="https://gry.github.io/images/zong%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/1561034397317.png">
<meta property="og:image" content="https://gry.github.io/images/zong%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/1561034443001.png">
<meta property="og:image" content="https://gry.github.io/images/zong%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/1561086689549.png">
<meta property="og:image" content="https://gry.github.io/images/zong%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/1561087565728.png">
<meta property="og:image" content="https://gry.github.io/images/zong%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/1561087807098.png">
<meta property="og:image" content="https://gry.github.io/images/zong%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/1561088012253.png">
<meta property="og:image" content="https://gry.github.io/images/zong%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/1561188756860.png">
<meta property="og:image" content="https://gry.github.io/images/zong%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/1561188862896.png">
<meta property="og:image" content="https://gry.github.io/images/zong%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/1561189231829.png">
<meta property="og:image" content="https://gry.github.io/images/zong%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/1561189366843.png">
<meta property="og:image" content="https://gry.github.io/images/zong%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/1561189402973.png">
<meta property="og:image" content="https://gry.github.io/images/zong%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/1561189505997.png">
<meta property="og:image" content="https://gry.github.io/images/zong%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/1561189545584.png">
<meta property="og:image" content="https://gry.github.io/images/zong%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/1561189612952.png">
<meta property="og:image" content="https://gry.github.io/images/zong%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/1561189661592.png">
<meta property="og:image" content="https://gry.github.io/images/zong%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/1561189716858.png">
<meta property="og:image" content="https://gry.github.io/images/zong%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/1561189733683.png">
<meta property="og:image" content="https://gry.github.io/images/zong%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/1561189772023.png">
<meta property="og:image" content="https://gry.github.io/images/zong%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/1561193163514.png">
<meta property="og:image" content="https://gry.github.io/images/zong%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/1561193119378.png">
<meta property="og:image" content="https://gry.github.io/images/zong%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/1561193262094.png">
<meta property="og:image" content="https://gry.github.io/images/zong%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/1561193438126.png">
<meta property="og:image" content="https://gry.github.io/images/zong%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/1561193864687.png">
<meta property="og:image" content="https://gry.github.io/images/zong%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/1561201862679.png">
<meta property="og:image" content="https://gry.github.io/images/zong%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/1561202519249.png">
<meta property="og:image" content="https://gry.github.io/images/zong%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/1561202524554.png">
<meta property="og:image" content="c:%5CUsers%5CAdministrator%5CDesktop%5CQQ%E5%9B%BE%E7%89%8720190622192244.png">
<meta property="og:image" content="https://gry.github.io/images/zong%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/1561202923888.png">
<meta property="og:image" content="https://gry.github.io/images/zong%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/1561203551230.png">
<meta property="og:image" content="https://gry.github.io/images/zong%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/1561203558191.png">
<meta property="og:image" content="https://gry.github.io/images/zong%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/1561203869582.png">
<meta property="og:image" content="https://gry.github.io/images/zong%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/1561203976866.png">
<meta property="og:image" content="https://gry.github.io/images/zong%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/1561204284074.png">
<meta property="og:image" content="https://gry.github.io/images/zong%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/9999.png">
<meta property="og:image" content="https://gry.github.io/images/zong%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/1561383715922.png">
<meta property="og:image" content="https://gry.github.io/images/zong%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/1561383744692.png">
<meta property="og:image" content="https://gry.github.io/images/zong%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/1561383959609.png">
<meta property="og:image" content="https://gry.github.io/images/zong%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/123.png">
<meta property="og:image" content="https://gry.github.io/images/zong%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/666.jpg.png">
<meta property="og:image" content="https://gry.github.io/images/zong%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/a2d19f5b73d622a5ed8178ad8abf9ee.png">
<meta property="og:image" content="https://gry.github.io/images/zong%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/1561636245384.png">
<meta property="og:image" content="https://gry.github.io/images/zong%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/1561636462837.png">
<meta property="og:image" content="https://gry.github.io/images/zong%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/1561637110944.png">
<meta property="og:image" content="https://gry.github.io/images/zong%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/1561637350549.png">
<meta property="og:image" content="https://gry.github.io/images/zong%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/1561637808820.png">
<meta property="og:image" content="https://gry.github.io/images/zong%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/1561638978222.png">
<meta property="og:image" content="https://gry.github.io/images/zong%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/1561639771300.png">
<meta property="og:image" content="https://gry.github.io/images/zong%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/1561687136829.png">
<meta property="og:image" content="https://gry.github.io/images/zong%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/1561687332348.png">
<meta property="og:image" content="https://gry.github.io/images/zong%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/1561689900776.png">
<meta property="og:image" content="https://gry.github.io/images/zong%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/1561690080444.png">
<meta property="og:image" content="https://gry.github.io/images/zong%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/1561689369125.png">
<meta property="og:image" content="https://gry.github.io/images/zong%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/1561788997663.png">
<meta property="og:image" content="https://gry.github.io/images/zong%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/1561789053237.png">
<meta property="og:image" content="https://gry.github.io/images/zong%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/1561790532353.png">
<meta property="og:image" content="https://gry.github.io/images/zong%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/1561790560131.png">
<meta property="og:updated_time" content="2019-10-30T12:49:24.165Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="综合架构">
<meta name="twitter:description" content="综合架构服务器配制方法">
<meta name="twitter:image" content="https://gry.github.io/images/zong%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/1560587760671.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://gry.github.io/2019/08/27/zong综合架构/">





  <title>综合架构 | GRY的博客</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">GRY的博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://gry.github.io/2019/08/27/zong综合架构/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="葛任远">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/head.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="GRY的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">综合架构</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-08-27T11:30:22+08:00">
                2019-08-27
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/" itemprop="url" rel="index">
                    <span itemprop="name">linux</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>综合架构服务器配制方法</p>
<a id="more"></a>


<p>一、综合架构的组成部分：</p>
<pre><code>1）防火墙服务器     实现访问流量安全控制             iptables（docker）/firewalld
2）负载均衡服务器    实现访问流量调度处理            nginx
3）web服务器       实现处理用户请求                 nginx
4）数据库服务器     实现数据信息存储（字符串）     mysql
5）存储服务器         实现数据信息存储（图片/附件）   NFS
6）备份服务器       实现数据信息备份               rsync（自动备份 shell+定时任务/sersync实时备份）
7）缓存服务器*      实现数据内存存储              memcache/redis/mongodb
8）批量管理服务器   实现服务器批量管理            ansible
9）监控服务器       实现监控服务运行状态/报警      zabbix</code></pre><h3 id="架构完善部分："><a href="#架构完善部分：" class="headerlink" title="架构完善部分："></a>架构完善部分：</h3><pre><code>1）解决单点问题     实现主备服务器切换              keepalived
2）VPN服务器        远程技术人员身份                pptpvpn （扩展研究）
   https://blog.gurenyunedu.com/?s=vpn
3）审计服务器       监控内部人员的所有操作          jumpserver（跳板机）</code></pre><h2 id="二、虚拟机架构规划"><a href="#二、虚拟机架构规划" class="headerlink" title="二、虚拟机架构规划"></a>二、虚拟机架构规划</h2><h3 id="1-虚拟机的配置"><a href="#1-虚拟机的配置" class="headerlink" title="1.虚拟机的配置"></a>1.虚拟机的配置</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">主机名称和IP地址规划  10台服务器 内存--10G</span><br><span class="line">	负载均衡服务器   lb01           10.0.0.5/24（外网）172.16.1.5/24（内网）</span><br><span class="line">	                 lb02           10.0.0.6/24（外网）172.16.1.6/24（内网）</span><br><span class="line">	web服务器        web01          10.0.0.7/24（外网）172.16.1.7/24（内网）</span><br><span class="line">                     web02          10.0.0.8/24（外网）172.16.1.8/24（内网）</span><br><span class="line">                     web03 			10.0.0.9/24（外网）172.16.1.9/24（内网）</span><br><span class="line">    数据库服务器     db01 			10.0.0.51/24（外网）172.16.1.51/24（内网）</span><br><span class="line">	存储服务器       nfs01 			10.0.0.31/24（外网）172.16.1.31/24（内网）</span><br><span class="line">    备份服务器       backup 		10.0.0.41/24（外网）172.16.1.41/24（内网）</span><br><span class="line">	批量管理服务器   m01 			10.0.0.61/24（外网）172.16.1.61/24（内网）</span><br><span class="line">	监控管理服务器   zabbix-server 	10.0.0.71/24（外网）172.16.1.71/24（内网）</span><br></pre></td></tr></table></figure>

<h3 id="2-主机（模板机）系统优化"><a href="#2-主机（模板机）系统优化" class="headerlink" title="2.主机（模板机）系统优化"></a>2.主机（模板机）系统优化</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">01. 安全优化</span><br><span class="line">	    防火墙关闭（永久）</span><br><span class="line">		selinux关闭（永久）</span><br><span class="line">	02. yum镜像源</span><br><span class="line">	    阿里云镜像源</span><br><span class="line">		清华yum源</span><br><span class="line">	03. 优化hosts文件</span><br></pre></td></tr></table></figure>

<h3 id="3-虚拟主机（模板机）网络配置"><a href="#3-虚拟主机（模板机）网络配置" class="headerlink" title="3.虚拟主机（模板机）网络配置"></a>3.虚拟主机（模板机）网络配置</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">   第一个步骤：创建第二块网卡，设置LAN区段 172.16.1.0</span><br><span class="line">第二个步骤：开启服务器，对第二块网卡进行地址配置</span><br><span class="line">            nmtui--systemctl restart NetworkManager --- systemctl restart network</span><br><span class="line">第三个步骤：清除网卡的mac地址信息和UUID</span><br><span class="line">            sed -i &apos;/UUID/d&apos; /etc/sysconfig/network-scripts/ifcfg-eth[01]</span><br><span class="line">第四个步骤：重启网卡服务</span><br><span class="line">            systemctl stop/disable NetworkManager</span><br><span class="line">			systemctl restart network</span><br></pre></td></tr></table></figure>

<h3 id="4-虚拟主机的克隆操作"><a href="#4-虚拟主机的克隆操作" class="headerlink" title="4.虚拟主机的克隆操作"></a>4.虚拟主机的克隆操作</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">第一个步骤：模板主机链接克隆</span><br><span class="line">	第二个步骤：需要对克隆好的主机进行配置</span><br><span class="line">	1）网卡地址修改</span><br><span class="line">	   sed -i &apos;s#200#41#g&apos; /etc/sysconfig/network-scripts/ifcfg-eth[01]</span><br><span class="line">	2）修改主机名称</span><br><span class="line">	   hostnamectl set-hostname backup</span><br><span class="line">	3）建立新的xshell会话</span><br><span class="line">	   systemctl restart network</span><br><span class="line">	   完整快照拍摄工作</span><br><span class="line">	</span><br><span class="line">	PS：克隆好的主机要一台一台启动配置</span><br></pre></td></tr></table></figure>

<h2 id="三、综合架构备份服务"><a href="#三、综合架构备份服务" class="headerlink" title="三、综合架构备份服务"></a>三、综合架构备份服务</h2><h3 id="ps-作用"><a href="#ps-作用" class="headerlink" title="ps:作用"></a>ps:作用</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1. 用于将数据信息进行恢复</span><br><span class="line">2. 用于出现问题进行文件信息对比</span><br></pre></td></tr></table></figure>

<h3 id="1-如何实现备份服务部署–rsync"><a href="#1-如何实现备份服务部署–rsync" class="headerlink" title="1.如何实现备份服务部署–rsync"></a>1.如何实现备份服务部署–rsync</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">rsync软件可以实现全量和增量备份	（优势）</span><br><span class="line">	增量备份是如何实现的？</span><br><span class="line">    两种方式：数学算法--数据比对</span><br><span class="line">    第一种：比对文件数据属性信息（默认）</span><br><span class="line">    第二种：比对文件md5数值</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">rsync软件 cp scp rm ls 1v4</span><br><span class="line">rsync替换cp：</span><br><span class="line">	cp /etc/hosts /tmp/      --- 备份文件</span><br><span class="line">	rsync /etc/hosts /tmp/   --- 备份文件</span><br><span class="line">    rsync -a /gurenyun /tmp    --- 备份目录</span><br><span class="line">    PS：rsync备份目录时</span><br><span class="line">	目录后面有/    gurenyun/   将目录下面的数据信息进行备份</span><br><span class="line">	目录后面没有/  gurenyun    将目录下面的内容以及目录备份都进行备份</span><br><span class="line">	</span><br><span class="line">rsync替换scp：远程备份</span><br><span class="line">	scp -rp /etc/hosts  172.16.1.31:/tmp   --- 远程传输备份文件</span><br><span class="line">	rsync -rp /etc/hosts  172.16.1.31:/tmp</span><br><span class="line">	（只有备份服务器开启rsync即可。）</span><br><span class="line"></span><br><span class="line">rsync替换rm：</span><br><span class="line">    mkdir /null</span><br><span class="line">    rsync -avz --delete /null/ /tmp   --- 将目录中的数据进行删除或者清空</span><br><span class="line">    --delete 无差异同步参数</span><br><span class="line">	</span><br><span class="line">rsync替换ls：</span><br><span class="line">	rsync /etc/hosts</span><br><span class="line">    -rw-r-xr-x            391 2019/06/11 09:36:15 hosts</span><br></pre></td></tr></table></figure>

<h3 id="2-rsync命令详细用法说明"><a href="#2-rsync命令详细用法说明" class="headerlink" title="2.rsync命令详细用法说明"></a>2.rsync命令详细用法说明</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">实现本地数据备份：等价于cp</span><br><span class="line">    Local:  rsync [OPTION...] SRC... [DEST]</span><br><span class="line">	src：需要备份的数据信息</span><br><span class="line">	dest：备份到什么路径中</span><br><span class="line"></span><br><span class="line">实现远程的方式备份：类似scp（全量备份）</span><br><span class="line">    Pull: rsync [OPTION...] [USER@]HOST:SRC... [DEST]</span><br><span class="line">	[USER@]： 以什么用户身份登录到远程主机，默认以当前登录用户身份登录远程主机</span><br><span class="line">	HOST：    远程主机IP地址或者主机名称信息</span><br><span class="line">	SRC：     需要拉取的远程主机数据信息</span><br><span class="line">	dest：    数据保存到本地主机的路径信息</span><br><span class="line">	</span><br><span class="line">	EX:  rsync -avz root@172.16.1.31:/etc/hosts ~</span><br><span class="line"></span><br><span class="line">    Push: rsync [OPTION...] SRC... [USER@]HOST:DEST</span><br><span class="line">	SRC：     需要推送的本地主机数据信息</span><br><span class="line">	[USER@]   以什么用户身份登录到远程主机，默认以当前登录用户身份登录远程主机</span><br><span class="line">	HOST：    远程主机IP地址或者主机名称信息</span><br><span class="line">	DEST：    数据保存到远程主机的路径信息</span><br><span class="line">	</span><br><span class="line">    EX：rsync -avz /etc/hosts root@172.16.1.31:~</span><br><span class="line"></span><br><span class="line">采用守护进程方式进行数据传输（远程方式）</span><br><span class="line">    Pull: rsync [OPTION...] [USER@]HOST::SRC... [DEST]</span><br><span class="line">          rsync [OPTION...] rsync://[USER@]HOST[:PORT]/SRC... [DEST]</span><br><span class="line">          </span><br><span class="line">        EX： rsync -avz  rsync_backup@172.16.1.41::backup/passwd ~</span><br><span class="line"></span><br><span class="line">    Push: rsync [OPTION...] SRC...         [USER@]HOST::DEST</span><br><span class="line">          rsync [OPTION...] SRC... rsync://[USER@]HOST[:PORT]/DEST</span><br><span class="line">          </span><br><span class="line">          EX： rsync -avzP /etc/hosts rsync_backup@172.16.1.41::backup</span><br><span class="line">          </span><br><span class="line">	      src:  需要推送的本地主机数据信息</span><br><span class="line">		  [USER@]: 输入正确认证用户信息</span><br><span class="line">		  HOST：   远程主机IP地址或者主机名称信息</span><br><span class="line">		  ::DEST   指定备份数据的模块信息</span><br><span class="line">		     </span><br><span class="line">优点：</span><br><span class="line">     1. 可以实现免交互传输数据</span><br><span class="line">	2. 实现远程传输认证功能</span><br><span class="line">	3. 守护进程方式具有配置文件，满足更多企业需求</span><br><span class="line">	4. 控制客户端连接服务端的数量</span><br></pre></td></tr></table></figure>

<h3 id="3-rsync守护进程的部署过程"><a href="#3-rsync守护进程的部署过程" class="headerlink" title="3.rsync守护进程的部署过程"></a>3.rsync守护进程的部署过程</h3><h4 id="服务端部署流程："><a href="#服务端部署流程：" class="headerlink" title="服务端部署流程："></a>服务端部署流程：</h4><table>
<thead>
<tr>
<th>第一步</th>
<th>确认软件是否安装</th>
<th>rpm -qa rsync</th>
</tr>
</thead>
<tbody><tr>
<td>第二步</td>
<td>未安装，安装</td>
<td>yum install -y rsync</td>
</tr>
<tr>
<td>第三步</td>
<td>编写配置文件</td>
<td>vim /etc/rsyncd.conf</td>
</tr>
<tr>
<td>第四步</td>
<td>创建备份管理用户</td>
<td>useradd rsync -s   /sbin/nologin -M</td>
</tr>
<tr>
<td>第五步</td>
<td>创建认证密码   放入passwordd文件</td>
<td>echo   “rsync_backup:gurenyun123” &gt;/etc/rsync.password</td>
</tr>
<tr>
<td>第六步</td>
<td>修改password   文件权限</td>
<td>chmod 600 /etc/rsync.password</td>
</tr>
<tr>
<td>第七步</td>
<td>创建备份目录</td>
<td>mkdir /backup</td>
</tr>
<tr>
<td>第八步</td>
<td>修改目录属组属主权限</td>
<td>chown rsync.rsync   /backup/</td>
</tr>
<tr>
<td>第九步</td>
<td>启动备份服务</td>
<td>systemctl   start rsyncd      systemctl enable rsyncd</td>
</tr>
<tr>
<td>第十步</td>
<td>检查服务进程是否存在</td>
<td>ps   ef|grep rsync</td>
</tr>
<tr>
<td>第十步</td>
<td>检查服务进程端口信息</td>
<td>netstat   -intup</td>
</tr>
</tbody></table>
<p><img src="/images/zong%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/1560587760671.png" alt="1560587760671"></p>
<h4 id="客户端部署流程："><a href="#客户端部署流程：" class="headerlink" title="客户端部署流程："></a>客户端部署流程：</h4><table>
<thead>
<tr>
<th>第一步</th>
<th>确认软件是否安装</th>
<th>rpm -qa rsync</th>
</tr>
</thead>
<tbody><tr>
<td>第二步</td>
<td>未安装，安装</td>
<td>yum install -y rsync</td>
</tr>
<tr>
<td>第三步</td>
<td>创建密码文件</td>
<td>echo   “gurenyun123” &gt;/etc/rsync.password</td>
</tr>
<tr>
<td>第四步</td>
<td>修改密码文件权限</td>
<td>chmod 600   /etc/rsync.password</td>
</tr>
<tr>
<td>第五步</td>
<td>备份数据传输</td>
<td>rsync -avzP   /etc/hosts <a href="mailto:rsync_backup@172.16.1.41" target="_blank" rel="noopener">rsync_backup@172.16.1.41</a>::backup</td>
</tr>
<tr>
<td>实现免交互传输数据（免秘钥）</td>
<td>rsync   -avzP /etc/hosts <a href="mailto:rsync_backup@172.16.1.41" target="_blank" rel="noopener">rsync_backup@172.16.1.41</a>::backup   –password-file=/etc/rsync.password</td>
<td></td>
</tr>
</tbody></table>
<p><img src="/images/zong%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/1560587803162.png" alt="1560587803162"></p>
<h4 id="配置文件："><a href="#配置文件：" class="headerlink" title="配置文件："></a>配置文件：</h4><p>#rsync_config</p>
<p>#created by HQ at 2017</p>
<p>##rsyncd.conf start##<br>uid = rsync<br>gid = rsync<br>port = 873</p>
<p>#fake super = yes<br>use chroot = no<br>max connections = 200<br>timeout = 300<br>pid file = /var/run/rsyncd.pid<br>lock file = /var/run/rsync.lock<br>log file = /var/log/rsyncd.log<br>ignore errors<br>read only = false<br>list = false<br>hosts allow = 172.16.1.0/24<br>hosts deny = 0.0.0.0/32<br>auth users = rsync_backup<br>secrets file = /etc/rsync.password<br>[backup]<br>comment = “backup dir by gurenyun”<br>path = /backup</p>
<h4 id="配置文件解析："><a href="#配置文件解析：" class="headerlink" title="配置文件解析："></a>配置文件解析：</h4><p>​    #rsync_config<br>​    #created by HQ at 2017<br>​    ##rsyncd.conf start##<br>​    uid = rsync           — 备份目录的管理用户（属主信息）？？？<br>​    gid = rsync           — 备份目录的管理用户（属组信息）？？？<br>​    port = 873            — rsync守护进程服务端口号<br>​    fake（伪装） super = yes    — ？？？<br>​    use chroot = no       — 和安全相关配置<br>​    max connections = 200   — 最大连接数<br>​    timeout = 300           — 设置连接的超时时间<br>​    pid file = /var/run/rsyncd.pid    — 记录服务的进程号码信息（停止服务/判断服务是否启动）<br>​    lock file = /var/run/rsync.lock   — 锁文件，进行连接的限制<br>​    log file = /var/log/rsyncd.log    — 服务的日志文件<br>​    ignore errors           — 忽略错误，提高传输数据效率<br>​    read only = false       — 设置备份目录是可读可写<br>​    list = false            — ？？？<br>​    hosts allow = 172.16.1.0/24       — 白名单（允许指定网段或者主机）<br>​    hosts deny = 0.0.0.0/32           — 黑名单（拒绝指定网段或者主机）<br>​    auth users = rsync_backup         — 指定认证的用户<br>​    secrets file = /etc/rsync.password    — 创建一个密码文件（用户名称:用户密码）<br>​    [backup]                          — 模块信息<br>​    comment = “backup dir by gurenyun”<br>​    path = /backup                    — 指定备份目录路径信息 </p>
<p><img src="/images/zong%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/1560587893342.png" alt="1560587893342"></p>
<h3 id="4-Rsync服务常见问题汇总讲解："><a href="#4-Rsync服务常见问题汇总讲解：" class="headerlink" title="4.Rsync服务常见问题汇总讲解："></a>4.Rsync服务常见问题汇总讲解：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br></pre></td><td class="code"><pre><span class="line">1. rsync服务端开启的iptables防火墙</span><br><span class="line">  【客户端的错误】</span><br><span class="line">   No route to host</span><br><span class="line">  【错误演示过程】</span><br><span class="line">   [root@nfs01 tmp]# rsync -avz /etc/hosts rsync_backup@172.16.1.41::backup</span><br><span class="line">   rsync: failed to connect to 172.16.1.41: No route to host (113)</span><br><span class="line">   rsync error: error in socket IO (code 10) at clientserver.c(124) [sender=3.0.6]</span><br><span class="line">  【异常问题解决】</span><br><span class="line">   关闭rsync服务端的防火墙服务（iptables）</span><br><span class="line">   [root@backup mnt]# /etc/init.d/iptables stop</span><br><span class="line">   iptables: Setting chains to policy ACCEPT: filter          [  OK  ]</span><br><span class="line">   iptables: Flushing firewall rules:                         [  OK  ]</span><br><span class="line">   iptables: Unloading modules:                               [  OK  ]</span><br><span class="line">   [root@backup mnt]# /etc/init.d/iptables status</span><br><span class="line">   iptables: Firewall is not running.</span><br><span class="line"></span><br><span class="line">2. rsync客户端执行rsync命令错误</span><br><span class="line">  【客户端的错误】</span><br><span class="line">   The remote path must start with a module name not a / </span><br><span class="line">  【错误演示过程】</span><br><span class="line">   [root@nfs01 tmp]# rsync -avz /etc/hosts rsync_backup@172.16.1.41::/backup</span><br><span class="line">   ERROR: The remote path must start with a module name not a /</span><br><span class="line">   rsync error: error starting client-server protocol (code 5) at main.c(1503) [sender=3.0.6]</span><br><span class="line">  【异常问题解决】</span><br><span class="line">   rsync命令语法理解错误，::/backup是错误的语法，应该为::backup(rsync模块)</span><br><span class="line"></span><br><span class="line">3. rsync服务认证用户失败</span><br><span class="line">  【客户端的错误】</span><br><span class="line">   auth failed on module gurenyun</span><br><span class="line">  【错误演示过程】</span><br><span class="line">   [root@nfs01 tmp]# rsync -avz /etc/hosts rsync_backup@172.16.1.41::backup</span><br><span class="line">   Password: </span><br><span class="line">   @ERROR: auth failed on module backup</span><br><span class="line">   rsync error: error starting client-server protocol (code 5) at main.c(1503) [sender=3.0.6]</span><br><span class="line">  【异常问题解决】</span><br><span class="line">   1. 密码真的输入错误，用户名真的错误</span><br><span class="line">   2. secrets file = /etc/rsync.password指定的密码文件和实际密码文件名称不一致</span><br><span class="line">   3. /etc/rsync.password文件权限不是600</span><br><span class="line">   4. rsync_backup:123456  密码配置文件后面注意不要有空格</span><br><span class="line">   5. rsync客户端密码文件中只输入密码信息即可，不要输入虚拟认证用户名称</span><br><span class="line"></span><br><span class="line">4. rsync服务位置模块错误</span><br><span class="line">  【客户端的错误】</span><br><span class="line">   Unknown module &apos;backup&apos;   </span><br><span class="line">  【错误演示过程】  </span><br><span class="line">   [root@nfs01 tmp]# rsync -avz /etc/hosts rsync_backup@172.16.1.41::backup</span><br><span class="line">   @ERROR: Unknown module &apos;backup&apos;</span><br><span class="line">   rsync error: error starting client-server protocol (code 5) at main.c(1503) [sender=3.0.6]</span><br><span class="line">  【异常问题解决】</span><br><span class="line">   1. /etc/rsyncd.conf配置文件模块名称书写错误</span><br><span class="line">   </span><br><span class="line">5. rsync服务权限阻止问题</span><br><span class="line">  【客户端的错误】</span><br><span class="line">   Permission denied</span><br><span class="line">  【错误演示过程】 </span><br><span class="line">   [root@nfs01 tmp]# rsync -avz /etc/hosts rsync_backup@172.16.1.41::backup</span><br><span class="line">   Password: </span><br><span class="line">   sending incremental file list</span><br><span class="line">   hosts</span><br><span class="line">   rsync: mkstemp &quot;.hosts.5z3AOA&quot; (in backup) failed: Permission denied (13) </span><br><span class="line">   sent 196 bytes  received 27 bytes  63.71 bytes/sec</span><br><span class="line">   total size is 349  speedup is 1.57</span><br><span class="line">   rsync error: some files/attrs were not transferred (see previous errors) (code 23) at main.c(1039) [sender=3.0.6]   </span><br><span class="line">  【异常问题解决】</span><br><span class="line">   1. 备份目录的属主和属组不正确，不是rsync</span><br><span class="line">   2. 备份目录的权限不正确，不是755</span><br><span class="line">   </span><br><span class="line">6. rsync服务备份目录异常</span><br><span class="line">  【客户端的错误】</span><br><span class="line">   chdir failed   </span><br><span class="line">  【错误演示过程】   </span><br><span class="line">   [root@nfs01 tmp]# rsync -avz /etc/hosts rsync_backup@172.16.1.41::backup</span><br><span class="line">   Password: </span><br><span class="line">   @ERROR: chdir failed</span><br><span class="line">   rsync error: error starting client-server protocol (code 5) at main.c(1503) [sender=3.0.6]</span><br><span class="line">  【异常问题解决】  </span><br><span class="line">   1. 备份存储目录没有建立</span><br><span class="line">   2. 建立的备份存储目录和配置文件定义不一致</span><br><span class="line">   说明：如果没有备份存储目录</span><br><span class="line"></span><br><span class="line">7. rsync服务无效用户信息</span><br><span class="line">  【客户端的错误】</span><br><span class="line">   invalid uid rsync</span><br><span class="line">  【错误演示过程】    </span><br><span class="line">   [root@nfs01 tmp]# rsync -avz /etc/hosts rsync_backup@172.16.1.41::backup</span><br><span class="line">   Password: </span><br><span class="line">   @ERROR: invalid uid rsync</span><br><span class="line">   rsync error: error starting client-server protocol (code 5) at main.c(1503) [sender=3.0.6]</span><br><span class="line">  【异常问题解决】  </span><br><span class="line">   rsync服务对应rsync虚拟用户不存在了</span><br><span class="line">	</span><br><span class="line">8. 客户端已经配置了密码文件，但免秘钥登录方式，依旧需要输入密码</span><br><span class="line">  【客户端的错误】</span><br><span class="line">   password file must not be other-accessible</span><br><span class="line">  【错误演示过程】 </span><br><span class="line">   [root@nfs01 tmp]# rsync -avz /etc/hosts rsync_backup@172.16.1.41::backup --password-file=/etc/rsync.password</span><br><span class="line">   password file must not be other-accessible</span><br><span class="line">   continuing without password file</span><br><span class="line">   Password: </span><br><span class="line">   sending incremental file list</span><br><span class="line">   sent 26 bytes  received 8 bytes  5.23 bytes/sec</span><br><span class="line">   total size is 349  speedup is 10.26</span><br><span class="line">  【异常问题解决】  </span><br><span class="line">   rsync客户端的秘钥文件也必须是600权限</span><br><span class="line"></span><br><span class="line">9. rsync客户端连接慢问题</span><br><span class="line">  【错误日志信息】 </span><br><span class="line">   错误日志输出</span><br><span class="line">   2017/03/08 20:14:43 [3422] params.c:Parameter() - Ignoring badly formed line in configuration file: ignore errors</span><br><span class="line">   2017/03/08 20:14:43 [3422] name lookup failed for 172.16.1.31: Name or service not known</span><br><span class="line">   2017/03/08 20:14:43 [3422] connect from UNKNOWN (172.16.1.31)</span><br><span class="line">   2017/03/08 20:14:43 [3422] rsync to backup/ from rsync_backup@unknown (172.16.1.31)</span><br><span class="line">   2017/03/08 20:14:43 [3422] receiving file list</span><br><span class="line">   2017/03/08 20:14:43 [3422] sent 76 bytes  received 83 bytes  total size 349</span><br><span class="line">   正确日志输出</span><br><span class="line">   2017/03/08 20:16:45 [3443] params.c:Parameter() - Ignoring badly formed line in configuration file: ignore errors</span><br><span class="line">   2017/03/08 20:16:45 [3443] connect from nfs02 (172.16.1.31)</span><br><span class="line">   2017/03/08 20:16:45 [3443] rsync to backup/ from rsync_backup@nfs02 (172.16.1.31)</span><br><span class="line">   2017/03/08 20:16:45 [3443] receiving file list</span><br><span class="line">   2017/03/08 20:16:45 [3443] sent 76 bytes  received 83 bytes  total size 349</span><br><span class="line">  【异常问题解决】</span><br><span class="line">   查看日志进行分析，编写rsync服务端hosts解析文件</span><br><span class="line"></span><br><span class="line">10 rsync服务没有正确启动</span><br><span class="line">  【错误日志信息】 </span><br><span class="line">   Connection refused (111)</span><br><span class="line">  【错误演示过程】 </span><br><span class="line">   [root@gurenyun-muban ~]#  rsync -avz /etc/hosts rsync_backup@172.16.1.41::backup</span><br><span class="line">   rsync: failed to connect to 172.16.1.41: Connection refused (111)</span><br><span class="line">   rsync error: error in socket IO (code 10) at clientserver.c(124) [sender=3.0.6]</span><br><span class="line">  【异常问题解决】</span><br><span class="line">   [root@gurenyun-muban ~]# rsync --daemon</span><br><span class="line">   [root@gurenyun-muban ~]# ss -lntup |grep rsync</span><br><span class="line">   tcp    LISTEN     0      5                     :::873                  :::*      users:((&quot;rsync&quot;,1434,5))</span><br><span class="line">   tcp    LISTEN     0      5                      *:873                   *:*      users:((&quot;rsync&quot;,1434,4))</span><br><span class="line">   [root@gurenyun-muban ~]# rsync -avz /etc/hosts rsync_backup@172.16.1.41::backup</span><br><span class="line">   Password: </span><br><span class="line">   sending incremental file list</span><br><span class="line">   hosts  </span><br><span class="line">   sent 196 bytes  received 27 bytes  49.56 bytes/sec</span><br><span class="line">   total size is 349  speedup is 1.57</span><br></pre></td></tr></table></figure>

<h3 id="5-rsync命令参数说明"><a href="#5-rsync命令参数说明" class="headerlink" title="5.rsync命令参数说明"></a>5.rsync命令参数说明</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">-v, --verbose		详细模式输出，传输时的进度等信息</span><br><span class="line">   -z, --compress		传输时进行压缩以提高传输效率，</span><br><span class="line">					--compress-level=NUM可按级别压缩。局域网可以不用压缩</span><br><span class="line">   -a, --archive		归档参数，表示以递归方式传输文件，并保持所有文件属性，等于-rtopgDl</span><br><span class="line">   -r, --recursive		对子目录以递归模式，即目录下的所有目录都同样传输，注意是小写r</span><br><span class="line">   -t, --times		    保持文件时间信息不变（mtime）</span><br><span class="line">   -o, --owner		    保持文件属主信息</span><br><span class="line">-g, --group		    保持文件属组信息</span><br><span class="line">   -p, --perms		    保持文件权限</span><br><span class="line">   -P, --progress	    显示同步的过程及传输时的进度等信息</span><br><span class="line">   -D, --devices 	    保持设备文件信息 b c s</span><br><span class="line">   -l, --links 		保留软链接（小写字母l）  没什么用</span><br><span class="line">-L, --copy-links    将链接文件源文件内容进行传输复制</span><br><span class="line">-e, --rsh=COMMAND	使用的信道协议（remote shell），指定替代rsh的shell程序。</span><br><span class="line">--exclude=PATTERN	指定排除不需要传输的文件信息(和tar参数一样)。？？？</span><br><span class="line">   --exclude-from=file	文件名所在的目录文件，即可以实现排除多个文件(和tar参数一样)。？？？</span><br><span class="line">--bwlimit=RATE	    limit I/O bandwidth; KBytes per second</span><br><span class="line">                       limit socket I/O bandwidth限速功能</span><br><span class="line">                       案例：某DBA做数据同步，带宽占满，导致用户无法访问网站  git						</span><br><span class="line">   --delete（慎用）	让目标目录SRC和源目录数据DST一致，即无差异同步数据。</span><br><span class="line">                    我有什么，你就有什么</span><br><span class="line">					我没什么，你也不能有</span><br><span class="line"></span><br><span class="line">补充：如何保证备份的数据属主和属组信息不变</span><br><span class="line"> 方法一：增加模块</span><br><span class="line"> 不同用户向不同模块传输数据</span><br><span class="line"> 方法二：修改配置文件uid信息</span><br><span class="line"> uid = root</span><br><span class="line"> gid = root</span><br><span class="line"> #fake super = yes</span><br><span class="line"> 备份目录属主属组需要修改为 root权限</span><br></pre></td></tr></table></figure>

<h3 id="5-rsync守护进程企业应用"><a href="#5-rsync守护进程企业应用" class="headerlink" title="5.rsync守护进程企业应用"></a>5.rsync守护进程企业应用</h3><h4 id="1）守护进程多模块功能配置"><a href="#1）守护进程多模块功能配置" class="headerlink" title="1）守护进程多模块功能配置"></a>1）守护进程多模块功能配置</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">开发人员</span><br><span class="line">	运维人员</span><br><span class="line">	数据库人员</span><br><span class="line">	创建多模块 --- 创建多模块对应目录并授权 --- 重启服务</span><br><span class="line">	[backup]</span><br><span class="line">    comment = &quot;backup dir by gurenyun&quot;</span><br><span class="line">    path = /backup</span><br><span class="line">    [devdir]</span><br><span class="line">    path = /devdir</span><br><span class="line">    [dbdir]</span><br><span class="line">    path = /dbdir</span><br></pre></td></tr></table></figure>

<h4 id="2）守护进程的排除功能实践"><a href="#2）守护进程的排除功能实践" class="headerlink" title="2）守护进程的排除功能实践"></a>2）守护进程的排除功能实践</h4><pre><code>环境准备：
    [root@nfs01 ~]# mkdir /gurenyun_dir/gurenyun{01..03} -p
    [root@nfs01 ~]# touch /gurenyun_dir/gurenyun{01..03}/{a..c}.txt
    [root@nfs01 ~]# tree /gurenyun_dir/
    /gurenyun_dir/
    ├── gurenyun01
    │?? ├── a.txt
    │?? ├── b.txt
    │?? └── c.txt
    ├── gurenyun02
    │?? ├── a.txt
    │?? ├── b.txt
    │?? └── c.txt
    └── gurenyun03
        ├── a.txt
        ├── b.txt
        └── c.txt
    需求：

1. 排除gurenyun01目录不要传输备份，排除gurenyun03目录中a.txt文件不要传输备份
   实现需求：--exclude=PATTERN
   [root@nfs01 ~]# rsync -avz /gurenyun_dir/ --exclude=gurenyun01 --exclude=gurenyun03/a.txt rsync_backup@172.16.1.41::backup --password-file=/etc/rsync.password
       sending incremental file list
       ./
       gurenyun02/
       gurenyun02/a.txt
       gurenyun02/b.txt
       gurenyun02/c.txt
       gurenyun03/
       gurenyun03/b.txt
       gurenyun03/c.txt
sent 381 bytes  received 134 bytes  1,030.00 bytes/sec
total size is 0  speedup is 0.00
总结：排除的路径信息，需要编写为指定目录的相对路径

常见错误：
1. 排除参数后面数据信息，不能写绝对路径
2. 排除参数后面数据信息，不能写相对路径

02. 排除的数据量比较大，有多个目录，多个文件都要排除
vim exlude.txt 
gurenyun01
gurenyun03/a.txt

[root@nfs01 gurenyun_dir]# rsync -avz /gurenyun_dir/ --exclude-from=/gurenyun_dir/exclude.txt rsync_backup@172.16.1.41::backup --password-file=/etc/rsync.password
sending incremental file list
./
exclude.txt
gurenyun02/
gurenyun02/a.txt
gurenyun02/b.txt
gurenyun02/c.txt
gurenyun03/
gurenyun03/b.txt
gurenyun03/c.txt

sent 482 bytes  received 157 bytes  1,278.00 bytes/sec
total size is 24  speedup is 0.04</code></pre><h4 id="3-守护进程来创建备份目录（全网备份项目）"><a href="#3-守护进程来创建备份目录（全网备份项目）" class="headerlink" title="3) 守护进程来创建备份目录（全网备份项目）"></a>3) 守护进程来创建备份目录（全网备份项目）</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">[root@nfs01 gurenyun_dir]# rsync -avz /etc/hosts rsync_backup@172.16.1.41::backup/gurenyun/ --password-file=/etc/rsync.password</span><br><span class="line">   sending incremental file list</span><br><span class="line">   created directory gurenyun</span><br><span class="line">   hosts</span><br><span class="line">   </span><br><span class="line">   sent 146 bytes  received 72 bytes  436.00 bytes/sec</span><br><span class="line">   total size is 158  speedup is 0.72</span><br><span class="line">   [root@nfs01 gurenyun_dir]# rsync -avz /etc/hosts rsync_backup@172.16.1.41::backup/gurenyun/gurenyun01/gurenyun02/gurenyun03/ --password-file=/etc/rsync.password</span><br><span class="line">   sending incremental file list</span><br><span class="line">   rsync: mkdir &quot;gurenyun/gurenyun01/gurenyun02/gurenyun03&quot; (in backup) failed: No such file or directory (2)</span><br><span class="line">   rsync error: error in file IO (code 11) at main.c(657) [Receiver=3.1.2]</span><br><span class="line">问题：不能创建多级目录</span><br><span class="line"></span><br><span class="line">nfs 数据备份 backup/172.16.1.31/ </span><br><span class="line">web 数据备份 backup/172.16.1.7/ </span><br><span class="line">db  数据备份 backup/172.16.1.51/</span><br></pre></td></tr></table></figure>

<h4 id="4-守护进程的访问控制配置"><a href="#4-守护进程的访问控制配置" class="headerlink" title="4) 守护进程的访问控制配置"></a>4) 守护进程的访问控制配置</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">hosts allow = 172.16.1.0/24</span><br><span class="line">   hosts deny = 172.17.1.0/24</span><br><span class="line">建议：尽量只使用一种名单</span><br><span class="line"></span><br><span class="line">补充：rsyncd.conf文件中全局配置和局部配置</span><br><span class="line">全局配置：模块以上的配置信息 影响全部模块</span><br><span class="line">局部配置：模块以下的配置信息 只影响当前模块  </span><br><span class="line">总结：局部配置优先于全局配置</span><br></pre></td></tr></table></figure>

<h4 id="5）守护进程无差异同步配置"><a href="#5）守护进程无差异同步配置" class="headerlink" title="5）守护进程无差异同步配置"></a>5）守护进程无差异同步配置</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">目录之间实现无差异同步</span><br><span class="line">rsync -avz /null/ --delete rsync_backup@172.16.1.41::backup </span><br><span class="line">PS: 可以快速清空目录中的数据</span><br><span class="line">文件之间实现无差异同步（没什么用）</span><br><span class="line">rsync -avz /gurenyun/hosts01 --delete rsync_backup@172.16.1.41::backup --password-file=/etc/rsync.password</span><br></pre></td></tr></table></figure>

<h4 id="6）守护进程的列表功能配置"><a href="#6）守护进程的列表功能配置" class="headerlink" title="6）守护进程的列表功能配置"></a>6）守护进程的列表功能配置</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">   list = true</span><br><span class="line">在客户端，显示服务端的所有模块信息</span><br></pre></td></tr></table></figure>

<p>### </p>
<h3 id="6-备份服务优缺点"><a href="#6-备份服务优缺点" class="headerlink" title="6.备份服务优缺点"></a>6.备份服务优缺点</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">优势：</span><br><span class="line">	1）可以实现增量备份</span><br><span class="line">	2）具有守护进程模式（服务端）</span><br><span class="line">	   认证管理控制</span><br><span class="line">	   实现白名单黑名单安全访问控制</span><br><span class="line">	   密码文件信息，可以实现免交互传输数据</span><br><span class="line">	   网络连接数量进行限制</span><br><span class="line">	3）实现数据的加密传输 -e  </span><br><span class="line">	缺点：</span><br><span class="line">	1）比较擅长传输大文件，传输大量小文件，出问题 （打包）</span><br><span class="line">	2）传输大文件，有可能会传输中断  --partial</span><br></pre></td></tr></table></figure>

<h4 id="服务配置文件被移动到其他路径，如何启动服务"><a href="#服务配置文件被移动到其他路径，如何启动服务" class="headerlink" title="服务配置文件被移动到其他路径，如何启动服务"></a>服务配置文件被移动到其他路径，如何启动服务</h4><p>​    rsync –daemon  –config=/tmp/rsyncd.conf</p>
<h2 id="四、综合架构存储服务器"><a href="#四、综合架构存储服务器" class="headerlink" title="四、综合架构存储服务器"></a>四、综合架构存储服务器</h2><h3 id="1-存储服务器概念介绍"><a href="#1-存储服务器概念介绍" class="headerlink" title="1.存储服务器概念介绍"></a>1.存储服务器概念介绍</h3><p>​    NFS是Network File System的缩写,中文意思是网络共享文件系统，<br>​    它的主要功能是通过网络（一般是局域网）让不同的主机系统之间可以共享文件或目录<br>​    </p>
<p>企业环境：实现数据共享存储</p>
<ol>
<li>FTP服务器（windows–server-U）  部署安装麻烦 / 权限设置</li>
<li>samba软件                       部署安装麻烦 windows linux系统都支持</li>
<li>分布式存储 Moosefs（mfs）、GlusterFS、FastDFS  </li>
</ol>
<h3 id="2-NFS存储服务器架构中作用"><a href="#2-NFS存储服务器架构中作用" class="headerlink" title="2.NFS存储服务器架构中作用"></a>2.NFS存储服务器架构中作用</h3><p>​    1.实现数据共享同一存储，保证数据一致性</p>
<p>​    2.降低公司架构服务器成本 </p>
<h3 id="3-NFS服务安装部署"><a href="#3-NFS服务安装部署" class="headerlink" title="3.NFS服务安装部署"></a>3.NFS服务安装部署</h3><p>   ps: RPC: 远程过程调用程序（开发网络编程）<br>              中介服务</p>
<h4 id="服务端部署："><a href="#服务端部署：" class="headerlink" title="服务端部署："></a>服务端部署：</h4><table>
<thead>
<tr>
<th>第一步</th>
<th>软件安装</th>
<th>yum install -y   nfs-utils rpcbind</th>
</tr>
</thead>
<tbody><tr>
<td>第二步</td>
<td>编写配置文件</td>
<td>vim /etc/exports</td>
</tr>
<tr>
<td>第三步</td>
<td>创建存储目录</td>
<td>mkdir /data</td>
</tr>
<tr>
<td>第四步</td>
<td>对目录授权</td>
<td>chown -R www. /data/</td>
</tr>
<tr>
<td>第五步</td>
<td>启动程序服务</td>
<td>systemctl   start rpcbind       systemctl start nfs</td>
</tr>
<tr>
<td>第六步</td>
<td>进行检查验证</td>
<td>rpcinfo   -p 172.16.1.31/10.0.0.31/localhost      — 检查nfs服务信息是否注册</td>
</tr>
<tr>
<td>第六步</td>
<td>进行检查验证</td>
<td>showmount   -e 172.16.1.31/10.0.0.31/localhost  —   检查是否有共享存储目录信息</td>
</tr>
</tbody></table>
<h4 id="客户端部署："><a href="#客户端部署：" class="headerlink" title="客户端部署："></a>客户端部署：</h4><table>
<thead>
<tr>
<th>第一步</th>
<th>软件安装</th>
<th>yum install -y   nfs-utils</th>
</tr>
</thead>
<tbody><tr>
<td>第二步</td>
<td>挂载存储目录</td>
<td>mount -t nfs  172.16.1.31:/data  /mnt</td>
</tr>
<tr>
<td>第三步</td>
<td>检查挂载</td>
<td>df -h</td>
</tr>
<tr>
<td>第四步</td>
<td>检查验证</td>
<td>showmount -e   172.16.1.31/10.0.0.31/localhost  —   检查是否有共享存储目录信息</td>
</tr>
</tbody></table>
<h3 id="4-nfs配置文件参数说明"><a href="#4-nfs配置文件参数说明" class="headerlink" title="4. nfs配置文件参数说明"></a>4. nfs配置文件参数说明</h3><p>vim /etc/exports</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">存储目录信息    主机地址或网段信息      权限</span><br><span class="line">/data           172.16.1.0/24        (rw,sync)    </span><br><span class="line"></span><br><span class="line">   rw         --- 设置共享目录权限为可读可写</span><br><span class="line">ro         --- 设置共享目录权限为只读</span><br><span class="line">                  企业应用：开发人员想查看线上服务器数据   线下服务器权限</span><br><span class="line">			   线下环境  线上环境不一致</span><br><span class="line">   sync       --- 同步存储数据  数据传输到服务器--磁盘 保证数据安全性   存储服务器</span><br><span class="line">async      --- 异步存储数据  数据传输到服务器--内存 保证数据传输效率</span><br><span class="line">   root_squash    --- root用户传输数据需要做映射转换   nfsnobody   OK</span><br><span class="line">no_root_squash --- root用户传输数据不需要做映射转换 root        OK</span><br><span class="line">all_squash     --- 普通用户传输数据需要做映射转换   nfsnobody   OK</span><br><span class="line">no_all_squash  --- 普通用户传输数据不需要做映射转换 原来是什么用户，存储好的数据就是什么用户管理  OK</span><br><span class="line">anonuid=1001,anongid=1001 ---指定映射的uid gid</span><br></pre></td></tr></table></figure>

<p><img src="%5CUsers%5CAdministrator%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5C3.png" alt="3"></p>
<h3 id="5-企业中：如何进行配置"><a href="#5-企业中：如何进行配置" class="headerlink" title="5.企业中：如何进行配置"></a>5.企业中：如何进行配置</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">   1. root是否应该做映射</span><br><span class="line">   no_root_squash：存储数据可以被客户端root用户随意改动</span><br><span class="line">      root_squash：   原有的其他用户文件不能查看，可以编辑  （推荐）</span><br><span class="line">2. 其他用户是否应该做映射：</span><br><span class="line">   no_all_squash： 目录属主修改好，有效提高存储目录安全  （推荐）</span><br><span class="line">      all_squash：    安全性较低</span><br><span class="line">   企业存储服务器部署方案：</span><br><span class="line">服务端</span><br><span class="line">第一个历程：编写配置文件</span><br><span class="line">vim /etc/exports</span><br><span class="line">   /data   172.16.1.0/24(rw,sync,root_squash,no_all_squash) </span><br><span class="line">   第二个历程：修改好目录权限</span><br><span class="line">   chown -R www. /data/</span><br><span class="line">第三个历程：重启服务</span><br><span class="line">systemctl restart nfs</span><br><span class="line"></span><br><span class="line">   客户端：</span><br><span class="line">第一个历程：进行挂载</span><br><span class="line">mount -t nfs 172.16.1.31:/data /mnt</span><br></pre></td></tr></table></figure>

<h3 id="6-NFS服务程序常见的问题总结"><a href="#6-NFS服务程序常见的问题总结" class="headerlink" title="6.NFS服务程序常见的问题总结"></a>6.NFS服务程序常见的问题总结</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">1）服务权限不正确：</span><br><span class="line">	   原因1：配置文件中权限参数书写不正确</span><br><span class="line">	   原因2：目录本身权限不正确   755  nfsnobody</span><br><span class="line">	   原因3：目录的权限具有继承关系</span><br><span class="line">	          PS：尽量存储服务配置文件中不要出现父子关系</span><br><span class="line">	   原因4：客户端挂载参数权限指定不正确</span><br><span class="line">	</span><br><span class="line">	2）错误信息：‘/data/w’: Stale file handle</span><br><span class="line">	   文件句柄错误：存储服务端有共享目录取消了，客户端并没进行卸载</span><br><span class="line">	   什么是卸载完整：cat /proc/mounts文件没有相关挂载信息了 </span><br><span class="line">	   解决：将所有挂载信息，进行卸载重新挂载</span><br><span class="line">	</span><br><span class="line">	3）存储服务无法进行启动：</span><br><span class="line">	   当服务没有启动的时候，无法使用reload进行启动</span><br><span class="line">	</span><br><span class="line">	4）clnt_create: RPC: Port mapper failure - Unable to receive: errno 113 (No route to host)</span><br><span class="line">	   原因：防火墙服务没有关闭 客户端 --- 访问 --- 服务端 111</span><br><span class="line">	   </span><br><span class="line">	5）RPC: Program not registered</span><br><span class="line">	   原因：rpcbind服务和nfs服务启动顺序不正确，nfs服务没有启动</span><br><span class="line">	   解决：两个服务全关闭，再按照顺序启动</span><br><span class="line">	   </span><br><span class="line">	6）无法卸载挂载目录：/data/w: device is busy</span><br><span class="line">	   第一种方式：离开挂载目录进行卸载</span><br><span class="line">	   第二种方式：强制卸载</span><br><span class="line">	               umount -lf 挂载点目录</span><br><span class="line">                   -l lazy(懒惰)</span><br><span class="line">				   -f force（强制）</span><br><span class="line">				   </span><br><span class="line">	7）nfs实现restart重启==放大招（大招冷却时间cd）</span><br><span class="line">	   在系统配置中/etc/sysconfig/nfs中指定了无敌时间的配置参数</span><br><span class="line">       NFSD_V4_GRACE=90</span><br><span class="line">       NFSD_V4_LEASE=90</span><br><span class="line">       NLM_GRACE_PERI0D=90</span><br><span class="line">	   </span><br><span class="line">	   补充：运维异常问题三种大招     被人攻击了  负载过高</span><br><span class="line">	   1. 服务重启</span><br><span class="line">	   2. 操作系统重启</span><br><span class="line">	   3. 服务或系统重装</span><br></pre></td></tr></table></figure>

<h3 id="7-存储服务重要文件-命令总结"><a href="#7-存储服务重要文件-命令总结" class="headerlink" title="7.存储服务重要文件/命令总结"></a>7.存储服务重要文件/命令总结</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">/etc/exports         存储服务端配置文件 </span><br><span class="line">	/usr/sbin/exportfs   负责平滑重启nfs服务</span><br><span class="line">	                     实践操作：</span><br><span class="line">	                     [root@nfs01 r]# exportfs -rv</span><br><span class="line">                         exporting 172.16.1.0/24:/data/w</span><br><span class="line">                         exporting 172.16.2.0/24:/data/r</span><br><span class="line">						 可以临时配置共享存储目录信息</span><br><span class="line">						 exportfs -o rw,sync 172.16.1.0/24:/data</span><br><span class="line">	/usr/sbin/showmount  检查可用存储共享目录信息</span><br><span class="line">	/var/lib/nfs/etab    nfs服务端默认配置信息记录文件（日志文件）</span><br><span class="line">	/proc/mounts         显示客户端挂载信息文件（默认挂载参数）</span><br></pre></td></tr></table></figure>

<h3 id="8-客户端如何实现自动挂载"><a href="#8-客户端如何实现自动挂载" class="headerlink" title="8.客户端如何实现自动挂载"></a>8.客户端如何实现自动挂载</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">方法一：/etc/fstab ---小问题？？？</span><br><span class="line">	编写fstab文件</span><br><span class="line">	172.16.1.31:/data/w       /data/w       nfs     defaults        0 0</span><br><span class="line">	</span><br><span class="line">	remote-fs.target  必须启动，才能加载fstab文件内容</span><br><span class="line">	</span><br><span class="line">	centos6: 系统启动流程 --- 串行启动</span><br><span class="line">	1. /etc/fstab   网络配置</span><br><span class="line">	2. network</span><br><span class="line">	3. netfs服务</span><br><span class="line">	   服务启动之后，重新加载fstab文件</span><br><span class="line">	</span><br><span class="line">	centos7: 系统启动流程 --- 并行启动</span><br><span class="line">	1. /etc/fstab </span><br><span class="line">	2. network  remote-fs</span><br><span class="line">	3. 系统启动完毕：重新加载fstab</span><br><span class="line">	</span><br><span class="line">	方法二：/etc/rc.local --- 文件权限是可执行权限</span><br><span class="line"></span><br><span class="line">    客户端挂载权限参数信息：</span><br><span class="line">	mount -o xx xx</span><br><span class="line">	客户端（开机自动挂载） --- 开机尝试挂载 --- nfs服务端</span><br></pre></td></tr></table></figure>

<h3 id="9-客户端挂载参数说明："><a href="#9-客户端挂载参数说明：" class="headerlink" title="9.客户端挂载参数说明："></a>9.客户端挂载参数说明：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">fg/bg：</span><br><span class="line">    fg：程序在前台运行  mount -t nfs xxx</span><br><span class="line">	bg：程序在后台运行  mount -t nfs -o bg</span><br><span class="line">    soft: 出现nfs服务端停止，只尝试挂载一段时间，一段时间过后停止挂载（腼腆的男孩）</span><br><span class="line">	hard: 出现nfs服务端停止，一直尝试挂载，根本停步下来（臭不要脸男孩）</span><br><span class="line">	rw/ro： 指定挂载点目录权限</span><br><span class="line">	suid/nosuid：特殊权限 setuid=suid      安全性</span><br><span class="line">	权限位：像文件所有者执行操作动作一样</span><br><span class="line">	suid：  挂载点目录中suid功能是可以起作用</span><br><span class="line">	nosuid：挂载点目录文件suid权限是没用的</span><br><span class="line">    exec/noexec：存储目录中的文件是否可以直接执行	</span><br><span class="line">	exec：可以让存储目录可执行文件直接运行 安全性</span><br><span class="line">	auto/noauto：fstab文件进行指定挂载参数</span><br><span class="line">	mount -a  快速加载fstab文件中配置信息</span><br><span class="line">	remount： 重新挂载</span><br><span class="line">	</span><br><span class="line">	企业案例：文件系统异常： 阵列 分区 格式化（创建文件系统 ext3 ext4 xfs） 挂载</span><br><span class="line">	什么是文件系统：数据进行存储方式（机制） fat32（单个文件不能大于4G）  ntfs（不管数据多大都可以直接存储）</span><br><span class="line">	系统全部数据出现只读情况</span><br><span class="line">	mount -o remount rw  /   </span><br><span class="line">	</span><br><span class="line">	架构中耦合度：（架构师）</span><br><span class="line">	架构中一台服务器出现问题，影响其他服务器运行  -- 紧耦合</span><br><span class="line">	架构中一台服务器出现问题，不会影响其它服务    -- 松耦合 （分布式存储）</span><br></pre></td></tr></table></figure>

<h2 id="五、综合架构远程连接（SSH）"><a href="#五、综合架构远程连接（SSH）" class="headerlink" title="五、综合架构远程连接（SSH）"></a>五、综合架构远程连接（SSH）</h2><h3 id="1-远程连接服务概念介绍"><a href="#1-远程连接服务概念介绍" class="headerlink" title="1.远程连接服务概念介绍"></a>1.远程连接服务概念介绍</h3><p> SSH:    系统默认配置      22  默认可以使用root用户进行登录   数据信息进行加密<br>    TELNET：网络设备默认开启  23  默认只能使用普通用户进行登录   数据信息显示明文</p>
<h3 id="2-远程连接服务连接原理"><a href="#2-远程连接服务连接原理" class="headerlink" title="2.远程连接服务连接原理"></a>2.远程连接服务连接原理</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">openssh   远程连接数据包进行加密处理</span><br><span class="line">   openssl   网站访问请求信息和响应信息进行加密（HTTPS）	</span><br><span class="line">原理总结：</span><br><span class="line">01. 客户端 - 服务端   请求建立ssh远程连接 </span><br><span class="line">02. 服务端 - 客户端   请求确认公钥信息</span><br><span class="line">03. 客户端 - 服务端   确认接收公钥信息，保存到~/.ssh/know_hosts文件中  </span><br><span class="line">04. 服务端 - 客户端   询问用户密码信息</span><br><span class="line">05. 客户端 - 服务端   用户密码信息</span><br><span class="line">06. 服务端 - 客户端   确认密码信息正确 远程连接建立</span><br><span class="line"></span><br><span class="line">01 之后：不用反复确认公钥信息</span><br><span class="line">06 之后：所有传输的数据信息会进行加密处理</span><br><span class="line">总结：</span><br><span class="line">作用01：利用公钥和私钥对数据信息进行加密处理</span><br><span class="line">作用02：对用户身份信息进行认证</span><br></pre></td></tr></table></figure>

<p>配图：</p>
<p>![057f503fbe2bad1c119b201b489f5](C:\Users\ADMINI~1\AppData\Local\Temp\WeChat Files\e5057f503fbe2bad1c119b201b489f5.png)</p>
<h3 id="3-远程连接通讯建立方式"><a href="#3-远程连接通讯建立方式" class="headerlink" title="3.远程连接通讯建立方式"></a>3.远程连接通讯建立方式</h3><p>基于口令方式（基于密码方式）</p>
<p>基于密钥方式</p>
<h3 id="4-基于密钥方式实现远程连接步骤："><a href="#4-基于密钥方式实现远程连接步骤：" class="headerlink" title="4.基于密钥方式实现远程连接步骤："></a>4.基于密钥方式实现远程连接步骤：</h3><h4 id="管理端服务器"><a href="#管理端服务器" class="headerlink" title="管理端服务器"></a>管理端服务器</h4><h5 id="1-创建密钥对信息"><a href="#1-创建密钥对信息" class="headerlink" title="1.创建密钥对信息"></a>1.创建密钥对信息</h5><p>ssh-keygen -t dsa</p>
<p>检查：ll ~/.ssh/id*</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[root@web01 ~]# ssh-keygen -t dsa</span><br><span class="line">    Generating public/private dsa key pair.</span><br><span class="line">    Enter file in which to save the key (/root/.ssh/id_dsa): </span><br><span class="line">    Enter passphrase (empty for no passphrase): </span><br><span class="line">    Enter same passphrase again: </span><br><span class="line">    Your identification has been saved in /root/.ssh/id_dsa.</span><br><span class="line">    Your public key has been saved in /root/.ssh/id_dsa.pub.</span><br><span class="line">    The key fingerprint is:</span><br><span class="line">    SHA256:v4ECG80UO1dv2WHn3jDkOrT/8luPwDks6NnGh4L8il8 root@web01</span><br><span class="line">    The key&apos;s randomart image is:</span><br><span class="line">    +---[DSA 1024]----+</span><br><span class="line">    |      .   .   + .|</span><br><span class="line">    |       o . . * + |</span><br><span class="line">    |      + .   = = .|</span><br><span class="line">    |     + o   o o +.|</span><br><span class="line">    |    o o S   +   o|</span><br><span class="line">    |     +   + o +   |</span><br><span class="line">    |    ....E.+.* . .|</span><br><span class="line">    |     .o+.o++.o.oo|</span><br><span class="line">    |    ..oo+oo.  .+=|</span><br><span class="line">    +----[SHA256]-----+</span><br><span class="line">    [root@web01 ~]# ll ~/.ssh/id*</span><br><span class="line">    -rw------- 1 root root 668 Jun 19 00:00 /root/.ssh/id_dsa</span><br><span class="line">    -rw-r--r-- 1 root root 600 Jun 19 00:00 /root/.ssh/id_dsa.pub</span><br></pre></td></tr></table></figure>

<h5 id="2-分发公钥"><a href="#2-分发公钥" class="headerlink" title="2.分发公钥"></a>2.分发公钥</h5><p>ssh-copy-id   -i   /root/.ssh/id_dsa.pub   <a href="mailto:root@172.16.1.31" target="_blank" rel="noopener">root@172.16.1.31</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@web01 ~]# ssh-copy-id -i /root/.ssh/id_dsa.pub root@172.16.1.31</span><br><span class="line">    /usr/bin/ssh-copy-id: INFO: Source of key(s) to be installed: &quot;/root/.ssh/id_dsa.pub&quot;</span><br><span class="line">    The authenticity of host &apos;172.16.1.31 (172.16.1.31)&apos; can&apos;t be established.</span><br><span class="line">    ECDSA key fingerprint is SHA256:E/rcVrdk84L/HagYfRXIz1QC1pERVXeaQiu8dfyF0qY.</span><br><span class="line">    ECDSA key fingerprint is MD5:3c:a2:1e:8f:33:48:56:1d:14:aa:5c:6e:31:a9:de:8c.</span><br><span class="line">    Are you sure you want to continue connecting (yes/no)? yes</span><br><span class="line">    /usr/bin/ssh-copy-id: INFO: attempting to log in with the new key(s), to filter out any that are already installed</span><br><span class="line">    /usr/bin/ssh-copy-id: INFO: 1 key(s) remain to be installed -- if you are prompted now it is to install the new keys</span><br><span class="line">    root@172.16.1.31&apos;s password: </span><br><span class="line">    </span><br><span class="line">    Number of key(s) added: 1</span><br><span class="line">    </span><br><span class="line">    Now try logging into the machine, with:   &quot;ssh &apos;root@172.16.1.31&apos;&quot;</span><br><span class="line">    and check to make sure that only the key(s) you wanted were added</span><br></pre></td></tr></table></figure>

<h5 id="3-检查确认"><a href="#3-检查确认" class="headerlink" title="3.检查确认"></a>3.检查确认</h5><p>ssh 172.16.1.31</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@web01 .ssh]# ssh 172.16.1.31</span><br><span class="line">    Last login: Tue Jun 18 23:37:04 2019 from 10.0.0.1</span><br><span class="line">    [root@nfs01 ~]# exit</span><br><span class="line">    logout</span><br><span class="line">    Connection to 172.16.1.31 closed.</span><br><span class="line">    [root@web01 .ssh]# ssh 172.16.1.31 hostname</span><br><span class="line">    nfs01</span><br></pre></td></tr></table></figure>

<h4 id="被管理端服务器"><a href="#被管理端服务器" class="headerlink" title="被管理端服务器"></a>被管理端服务器</h4><h5 id="1-检查确认"><a href="#1-检查确认" class="headerlink" title="1.检查确认"></a>1.检查确认</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@nfs01 ssh]# cd /root/.ssh/</span><br><span class="line">    [root@nfs01 .ssh]# ll</span><br><span class="line">    total 8</span><br><span class="line">    -rw------- 1 root root 600 Jun 19 00:04 authorized_keys</span><br><span class="line">    -rw-r--r-- 1 root root 346 Jun 18 02:31 known_hosts</span><br><span class="line">    [root@nfs01 .ssh]# cat authorized_keys </span><br><span class="line">    ssh-dss AAAAB3NzaC1kc3MAAACBALkIMlfU30rSp6A9F0+LMg5cPRbDoPlCTm82FuOVXMKieeqniuOMgRSsRlUIwuEIe1e3fwTGmwoKdYGa4RaV8S3ZFm+dc1rEFOIOgC2GLRjLRf14Hmp9ZMOQVpE6AWycs2ziImhxYznawjMm4YgYUGpkeobhM++6ri3MRd+J6wpXAAAAFQD3mmoOxftbuAShzVMzeD/y4T36SQAAAIBfgM8KWsy2+sJRsqKeGmjiXr7OXLTtPaeWjEhJc/Q06HyWuV/K0Phr+c8KHGL1ClgPr0/uUpmoelVy9/ng53olqNy2Vyb6QMyIfenBj6OlQ96WBKNOregKCMgbpOquYgXhCVWMELv7b8PTOV6Rrx1vD0hQI/V9hFTLIYxE95eoqwAAAIA4gYv/P2yJKa156sTPyk+F/e7oMgM5rcpGuLSRk4DV779GE7NFU33A9Xia6EbxDL1fzfkRq3YP83lpmrFYbg8UkEwZpLIPlmshIrvQsuVFnV9nt8JE+uQR75KhT0jTGZZv2mZ+g7NIWDEa1QFsbo+9Nauj8yADiLzXmXrDXCC2nw== root@web01</span><br></pre></td></tr></table></figure>

<h5 id="2-解决免交互问题："><a href="#2-解决免交互问题：" class="headerlink" title="2.解决免交互问题："></a>2.解决免交互问题：</h5><pre><code>01. 第一次连接有yes/no 
ssh-copy-id -i /root/.ssh/id_rsa.pub 172.16.1.7 -o StrictHostKeyChecking=no
   1. 需要有密码信息确认

 yum install -y sshpass
 sshpass -p123456 ssh-copy-id -i /root/.ssh/id_rsa.pub 172.16.1.7 -o StrictHostKeyChecking=no

ssh-copy-id分发公钥原理：
01. 进行ssh远程连接
02. scp将公钥进行传输
03. 被管理端将公钥保存到用户家目录中的.ssh目录中
04. 修改公钥文件名称和权限  authorized_keys  600</code></pre><p>分发脚本：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">vim /server/scripts/fenfa_key.sh</span><br><span class="line">#!/bin/bash</span><br><span class="line">for ip in &#123;7,31,41&#125;</span><br><span class="line">do</span><br><span class="line">  echo &quot;===============start fenfa_Key to 172.16.1.$ip=========================&quot;</span><br><span class="line">  sshpass -p123456 ssh-copy-id -i /root/.ssh/id_rsa.pub 172.16.1.$ip -o StrictHostKeyChecking=no &amp;&gt;/dev/null</span><br><span class="line">  if [ $? -eq 0 ]</span><br><span class="line">  then</span><br><span class="line">     echo &quot;===============pub_key fenfa ok with 172.16.1.$ip=========================&quot;</span><br><span class="line">     echo &quot;&quot;</span><br><span class="line">  else</span><br><span class="line">     echo &quot;===============pub_key fenfa failed with 172.16.1.$ip=========================&quot;</span><br><span class="line">     echo &quot;&quot;</span><br><span class="line">  fi </span><br><span class="line">done</span><br></pre></td></tr></table></figure>

<p>检查脚本：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@m01 scripts]# vim fenfa_check.sh </span><br><span class="line">#!/bin/bash</span><br><span class="line">if [ $# -ne 1 ]</span><br><span class="line">then</span><br><span class="line">  echo &quot;Usage: $0 请在脚本后面输入一个命令信息&quot;</span><br><span class="line">  exit 100</span><br><span class="line">fi</span><br><span class="line">for ip in &#123;7,31,41&#125;</span><br><span class="line">do</span><br><span class="line">  echo &quot;===============start fenfa_Key to 172.16.1.$ip=========================&quot;</span><br><span class="line">  ssh 172.16.1.$ip $1</span><br><span class="line">done</span><br></pre></td></tr></table></figure>

<p>补充：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">if判断比较信息：</span><br><span class="line">	=    -eq   equal</span><br><span class="line">	&gt;    -gt   greater than</span><br><span class="line">	&lt;    -lt   less than</span><br><span class="line">	&gt;=   -ge   greater equal</span><br><span class="line">	&lt;=   -le   less equal</span><br><span class="line">	&lt;&gt;   -ne   no equal</span><br></pre></td></tr></table></figure>

<p>分发公钥问题说明：</p>
<pre><code>01.  密码信息不正确
02. 免密码分发公钥  yum install -y sshpass 
03. 分发公钥信息，需要分发你有的公钥   是否有公钥 m01--/root/.ssh/id_xsa.pub


排错方法：
01. 测试脚本  ssh 172.16.1.7 hostname
02. 脚本中命令手动执行
    sshpass -p123456 ssh-copy-id -i /root/.ssh/id_rsa.pub 172.16.1.$ip -o StrictHostKeyChecking=no</code></pre><h5 id="3-远程服务端口号发生变化了，如何修改脚本命令"><a href="#3-远程服务端口号发生变化了，如何修改脚本命令" class="headerlink" title="3. 远程服务端口号发生变化了，如何修改脚本命令"></a>3. 远程服务端口号发生变化了，如何修改脚本命令</h5><p>​    centos7：掌握<br>​    sshpass -p123456 ssh-copy-id -i /root/.ssh/id_rsa.pub 172.16.1.7 -o StrictHostKeyChecking=no -p 52113<br>​    centos6：分发公钥<br>​    sshpass -p123456 ssh-copy-id -i /root/.ssh/id_dsa.pub “10.0.0.7 -o StrictHostKeyChecking=no -p 52113”</p>
<h5 id="4-SSH服务端配置文件说明："><a href="#4-SSH服务端配置文件说明：" class="headerlink" title="4. SSH服务端配置文件说明："></a>4. SSH服务端配置文件说明：</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/ssh/sshd_config</span><br><span class="line">    #Port 22                 --- 指定服务端口号信息</span><br><span class="line">    #ListenAddress 0.0.0.0   --- 指定相应网卡可以接收远程访问请求  web</span><br><span class="line">                                 默认：主机上所有网卡都可以接收远程连接请求</span><br><span class="line">								 监听地址信息，一定是本地网卡上有的地址信息 ******</span><br><span class="line">	#PermitEmptyPasswords no --- 是否允许空密码登录</span><br><span class="line">	#PermitRootLogin yes     --- 不允许root用户登录</span><br><span class="line">115 #UseDNS yes              --- 是否进行DNS反向解析 no  172.16.1.31 --&gt; 172.16.1.61 </span><br><span class="line"> 79 GSSAPIAuthentication yes --- 是否开启GSSAPI  no</span><br></pre></td></tr></table></figure>

<h5 id="5-SSH防范远程入侵方案"><a href="#5-SSH防范远程入侵方案" class="headerlink" title="5.SSH防范远程入侵方案"></a>5.SSH防范远程入侵方案</h5><p><a href="https://blog.51cto.com/phenixikki/1546669" target="_blank" rel="noopener">https://blog.51cto.com/phenixikki/1546669</a><br>    1. 用密钥登录，不用密码登陆<br>    2. 防火墙封闭SSH,指定源IP限制(局域网、信任公网)  ？？？<br>    3. 尽量不给服务器外网IP<br>    4. 负载均衡主机，只监听内网地址的远程访问<br>    5. 最小化（软件安装-授权）  web nfs rsync mysql zabbix … 端口（门）<br>       yum install -y nmap  — 扫描网站端口信息<br>       nmap -p 1-65535 <a href="http://www.baidu.com" target="_blank" rel="noopener">www.baidu.com</a>   80 443<br>    6. 给系统的重要文件或命令做一个指纹   md5sum -c /etc/passwd  abcd  — zabbix<br>    7. chattr +i 锁住文件  </p>
<h3 id="5-远程服务相关命令"><a href="#5-远程服务相关命令" class="headerlink" title="5.远程服务相关命令"></a>5.远程服务相关命令</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">a） ssh</span><br><span class="line">	ssh [参数] [user@]主机信息 </span><br><span class="line">	参数：-p  指定端口信息</span><br><span class="line">	      -o  指定特殊参数功能</span><br><span class="line">	[user@]:  以什么用户身份远程连接到主机上（默认当前用户）</span><br><span class="line">	主机信息：IP地址 或者 主机名称（本地hosts文件需要解析）</span><br><span class="line"></span><br><span class="line">    b） scp  远程传输数据（全量）</span><br><span class="line">    推：scp [参数]  src  [user@]主机信息:/dest</span><br><span class="line">    拉: scp [参数]  [user@]主机信息:/src  /dest	</span><br><span class="line">    参数：-r   递归复制数据信息（目录）</span><br><span class="line">	      -p   保持文件数据属性信息不变</span><br><span class="line"></span><br><span class="line">    c） sftp 远程文件数据传输</span><br><span class="line">	sftp [参数]  [user@]主机信息 </span><br><span class="line">	-P port</span><br><span class="line">	如何下载数据：</span><br><span class="line">    cd /backup        --- 切换到远程ftp服务端指定目录</span><br><span class="line">    get gurenyun61.txt  --- 默认下载数据，会下载到进入ftp模式之前的目录中</span><br><span class="line">	mget xx xx        --- 批量下载多个文件</span><br><span class="line">	lcd /gurenyun       --- 所有命令前面加上l 表示操作本地主机数据信息</span><br><span class="line">	</span><br><span class="line">	如何上传数据：</span><br><span class="line">	put gurenyun.txt</span><br><span class="line">	mput              --- 批量上传多个文件</span><br></pre></td></tr></table></figure>

<p>六、ansible批量管理服务</p>
<h3 id="1-服务概述"><a href="#1-服务概述" class="headerlink" title="1.服务概述"></a>1.服务概述</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">ansible批量功能          -- 并行</span><br><span class="line">	01. 可以实现批量系统操作配置</span><br><span class="line">    02. 可以实现批量软件服务部署</span><br><span class="line">    03. 可以实现批量文件数据分发</span><br><span class="line">    04. 可以实现批量系统信息收集</span><br><span class="line">    </span><br><span class="line">    ansible批量管理服务意义   </span><br><span class="line">	01. 提高工作的效率（部署综合架构）  </span><br><span class="line">	02. 提高工作准确度</span><br><span class="line">	03. 减少维护的成本</span><br><span class="line">	04. 减少重复性工作</span><br></pre></td></tr></table></figure>

<h3 id="2-ansible软件学习方法"><a href="#2-ansible软件学习方法" class="headerlink" title="2.ansible软件学习方法"></a>2.ansible软件学习方法</h3><ol>
<li>官方资料：docs.ansible.com</li>
<li>通过帮助命令：<pre><code>ansible-doc -l      --- 查看模块的作用说明
   ansible-doc -s yum  --- 查看指定模块参数说明
   ansible-doc yum     --- 显示模块详细说明</code></pre></li>
<li>总结学习过的模块</li>
</ol>
<h3 id="3-ansible软件安装部署"><a href="#3-ansible软件安装部署" class="headerlink" title="3.ansible软件安装部署"></a>3.ansible软件安装部署</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">altstack自动化批量管理软件 （复杂（安装 配置 应用））  软件服务比较重</span><br><span class="line">    特点：</span><br><span class="line">	1. 没有配置文件（不需要配置）</span><br><span class="line">	2. 不需要启动服务</span><br><span class="line">	3. 客户端没有需要部署任务</span><br><span class="line">    </span><br><span class="line">    管理服务器：</span><br><span class="line">	第一个历程：安装ansible软件</span><br><span class="line">	yum install -y ansible   -- epel</span><br></pre></td></tr></table></figure>

<h4 id="测试ansible连接失败，排错思路："><a href="#测试ansible连接失败，排错思路：" class="headerlink" title="测试ansible连接失败，排错思路："></a>测试ansible连接失败，排错思路：</h4><ol>
<li>利用SSH远程连接测试   （重新分发公钥）<ol start="2">
<li>SSH测试成功，ansible测试失败<br>在被管理主机上，杀死ssh特殊进程<br>sshd: root@notty</li>
</ol>
</li>
</ol>
<h3 id="4-ansible软件配置应用"><a href="#4-ansible软件配置应用" class="headerlink" title="4.ansible软件配置应用"></a>4.ansible软件配置应用</h3><p>ansible软件功能组成模块：<br>    1）主机清单功能模块： /etc/ansible/ hosts</p>
<p>​    2）剧本功能模块</p>
<p>​    3）核心或自定义模块</p>
<p>​    4）插件功能（python）</p>
<h3 id="5-主机清单如何配置："><a href="#5-主机清单如何配置：" class="headerlink" title="5.主机清单如何配置："></a>5.主机清单如何配置：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">第一种配置方法：指定主机组配置</span><br><span class="line">	[gurenyun]</span><br><span class="line">    172.16.1.41</span><br><span class="line">    172.16.1.31</span><br><span class="line">    [oldgirl]</span><br><span class="line">    172.16.1.7</span><br></pre></td></tr></table></figure>

<p><img src="/images/zong%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/1561191549174.png" alt="1561191549174"></p>
<p><img src="/images/zong%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/1561191568297.png" alt="1561191568297"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">第二种配置方法：支持主机名符号匹配配置</span><br><span class="line">    [gurenyun]</span><br><span class="line">    172.16.1.[1:50]</span><br><span class="line">    web[01:03]</span><br></pre></td></tr></table></figure>

<p><img src="/images/zong%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/1561191623567.png" alt="1561191623567"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">第三种配置方法：支持内置变量信息配置</span><br><span class="line">[gurenyun]</span><br><span class="line">172.16.1.7  ansible_ssh_user=root ansible_ssh_pass=123456 ansible_ssh_port=22</span><br><span class="line">[gurenyun]</span><br><span class="line">172.16.1.7  ansible_user=root ansible_password=123456 ansible_port=22</span><br></pre></td></tr></table></figure>

<p><img src="/images/zong%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/1561191651334.png" alt="1561191651334"></p>
<p><img src="/images/zong%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/1561191661913.png" alt="1561191661913"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">第四种配置方法：支持特殊变量信息配置 （剧本）</span><br><span class="line">    [gurenyun]</span><br><span class="line">    172.16.1.7</span><br><span class="line">    [gurenyun:vars]</span><br><span class="line">    ansible_user=root </span><br><span class="line">    ansible_password=123456 </span><br><span class="line">    ansible_port=22</span><br></pre></td></tr></table></figure>

<p><img src="/images/zong%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/1561191682898.png" alt="1561191682898"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">第五种配置方法：嵌入式配置方法</span><br><span class="line">[backup:children]</span><br><span class="line">backupclient</span><br><span class="line">backupserver</span><br><span class="line">[backupclient]</span><br><span class="line">    172.16.1.7  ansible_user=root ansible_password=123456</span><br><span class="line">    172.16.1.31</span><br><span class="line">    [backupserver]</span><br><span class="line">    172.16.1.41</span><br><span class="line">    </span><br><span class="line">    官方资料参考：https://docs.ansible.com/ansible/latest/user_guide/intro_inventory.html</span><br></pre></td></tr></table></figure>

<p><img src="/images/zong%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/1561191737865.png" alt="1561191737865"></p>
<h3 id="6-批量管理模块使用方法"><a href="#6-批量管理模块使用方法" class="headerlink" title="6.批量管理模块使用方法"></a>6.批量管理模块使用方法</h3><h4 id="补充：ansible输出信息有颜色显示："><a href="#补充：ansible输出信息有颜色显示：" class="headerlink" title="补充：ansible输出信息有颜色显示："></a>补充：ansible输出信息有颜色显示：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">绿色： 操作执行成功，没有对远程主机做任何改动</span><br><span class="line">黄色： 操作执行成功，对远程主机数据信息有改动</span><br><span class="line">红色： 操作执行失败</span><br><span class="line">粉色： 操作警告信息（忠告）</span><br><span class="line">蓝色： 显示命令操作执行的过程</span><br></pre></td></tr></table></figure>

<p>模块作用：完成不同的批量管理功能  ping（测试）：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">显示ansible所有模块数量：</span><br><span class="line">[root@m01 ansible]# ansible-doc -l|wc -l</span><br><span class="line">   2834</span><br><span class="line">10几个模块掌握</span><br><span class="line"></span><br><span class="line">ansible命令语法：</span><br><span class="line">ansible  主机信息（IP 主机组 all） -m  （模块名）command  -a  &quot;操作动作&quot;      </span><br><span class="line">   01          02                  03         04          05     06</span><br></pre></td></tr></table></figure>

<h4 id="第一个模块：命令模块-command（默认）"><a href="#第一个模块：命令模块-command（默认）" class="headerlink" title="第一个模块：命令模块 - command（默认）"></a>第一个模块：命令模块 - command（默认）</h4><p>作用：在目标主机执行命令：<br>    参数：<br>    chdir：    在执行命令前，先切换目录信息<br>    creates：  判断一个文件是否存在，如果存在，后面命令被跳过（不执行）<br>    removes：  判断一个文件是否存在，如果存在，后面命令就执行<br>    free_form：在使用command模块时候必须输入一个合法的linux命令 </p>
<p>ps： ansible backup -m command -a “hostname”</p>
<p><img src="/images/zong%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/1561034397317.png" alt="1561034397317"></p>
<h5 id="特殊用法：chdir-参数"><a href="#特殊用法：chdir-参数" class="headerlink" title="特殊用法：chdir 参数"></a>特殊用法：chdir 参数</h5><p>ansible backup -m command -a “chdir=/tmp pwd”</p>
<p>ps：在执行命令前，先切换目录信息</p>
<p><img src="/images/zong%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/1561034443001.png" alt="1561034443001"></p>
<h5 id="特殊用法：creates-参数"><a href="#特殊用法：creates-参数" class="headerlink" title="特殊用法：creates 参数"></a>特殊用法：creates 参数</h5><p>ansible backup -m command -a “creates=/etc/gurenyun.txt touch /opt/gurenyun.txt”</p>
<p>ps：  判断一个文件是否存在，如果存在，后面命令被跳过（不执行）</p>
<h5 id="特殊用法：removes-参数"><a href="#特殊用法：removes-参数" class="headerlink" title="特殊用法：removes 参数"></a>特殊用法：removes 参数</h5><p>ansible backup -m command -a “removes=/etc/gurenyun.txt touch /opt/gurenyun.txt”</p>
<p>ps:判断一个文件是否存在，如果存在，后面命令就执行</p>
<h4 id="第二个模块：命令模块-shell（万能模块）"><a href="#第二个模块：命令模块-shell（万能模块）" class="headerlink" title="第二个模块：命令模块 - shell（万能模块）"></a>第二个模块：命令模块 - shell（万能模块）</h4><p>后面跟linux命令</p>
<p><img src="/images/zong%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/1561086689549.png" alt="1561086689549"></p>
<h4 id="第三个模块：命令模块-script-（执行脚本）、"><a href="#第三个模块：命令模块-script-（执行脚本）、" class="headerlink" title="第三个模块：命令模块 - script （执行脚本）、"></a>第三个模块：命令模块 - script （执行脚本）、</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">shell 模块执行脚本</span><br><span class="line">	第一个历程：编写脚本</span><br><span class="line">	[root@m01 scripts]# cat yum.sh </span><br><span class="line">    #!/bin/bash</span><br><span class="line">    yum install -y iftop</span><br><span class="line">	第二个历程：批量分发脚本文件</span><br><span class="line">	ansible backup -m copy -a &quot;src=/server/scripts/yum.sh dest=/server/scripts/&quot;</span><br><span class="line">	第三个历程：修改脚本权限</span><br><span class="line">	ansible backup -m shell -a &quot;chmod a+x /server/scripts/yum.sh&quot;</span><br><span class="line">	第四个历程：运行脚本</span><br><span class="line">	ansible backup -m shell -a &quot;rpm -qa iftop</span><br></pre></td></tr></table></figure>

<p>vs：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">script 模块执行脚本 </span><br><span class="line">	第一个历程：编写脚本</span><br><span class="line">	[root@m01 scripts]# cat yum.sh </span><br><span class="line">    #!/bin/bash</span><br><span class="line">    yum install -y iftop</span><br><span class="line">    第二个历程：运行脚本	</span><br><span class="line">	ansible backup -m script -a &quot;/server/scripts/yum.sh&quot;</span><br></pre></td></tr></table></figure>

<p>所以： shell模块虽然是万能模块，但最好选择专业的模块完成专业事情</p>
<h4 id="第四个模块：文件模块-copy-（批量分发文件—推）"><a href="#第四个模块：文件模块-copy-（批量分发文件—推）" class="headerlink" title="第四个模块：文件模块 - copy （批量分发文件—推）"></a>第四个模块：文件模块 - copy （批量分发文件—推）</h4><p>​    作用： </p>
<pre><code>   1. 分发文件数据信息     从管理端 -- 被管理端
   2. 修改文件权限属性信息  
   3. 移动远程主机数据信息 被管理端 -- /tmp/gurenyun.txt --- /opt/     

参数： 
src： 指定要推送的数据信息
dest：指定数据保存在远程主机什么目录中
mode：修改文件权限信息
owner：修改文件属主信息
group：修改文件属组信息
backup: 分发文件数据时，会对源文件进行备份
remote_src: 复制远程主机文件到其他路径，或者进行远程主机数据备份
content:  直接编辑文件内容  </code></pre><p><img src="/images/zong%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/1561087565728.png" alt="1561087565728"></p>
<h5 id="特殊用法：传输文件时，修改文件权限"><a href="#特殊用法：传输文件时，修改文件权限" class="headerlink" title="特殊用法：传输文件时，修改文件权限"></a>特殊用法：传输文件时，修改文件权限</h5><p>ansible backup -m copy -a “src=/etc/hosts dest=/etc/hosts.bak mode=600 owner=root group=root”</p>
<p><img src="/images/zong%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/1561087807098.png" alt="1561087807098"></p>
<h5 id="特殊用法：分发文件时，对源文件进行备份"><a href="#特殊用法：分发文件时，对源文件进行备份" class="headerlink" title="特殊用法：分发文件时，对源文件进行备份"></a>特殊用法：分发文件时，对源文件进行备份</h5><p>ansible backup -m copy -a “src=/etc/hosts dest=/etc/ backup=yes”</p>
<p><img src="/images/zong%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/1561088012253.png" alt="1561088012253"></p>
<h5 id="特殊用法：远程主机文件进行复制备份（便于批量还原）"><a href="#特殊用法：远程主机文件进行复制备份（便于批量还原）" class="headerlink" title="特殊用法：远程主机文件进行复制备份（便于批量还原）"></a>特殊用法：远程主机文件进行复制备份（便于批量还原）</h5><p>ps:远程主机的文件进行备份</p>
<p>ansible backup -m copy -a “src=/etc/hosts dest=/etc/hosts.backup  remote_src=yes”</p>
<p><img src="/images/zong%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/1561188756860.png" alt="1561188756860"></p>
<p>批量还原：</p>
<p>ansible backup -m copy -a “src=/etc/hosts.backup dest=/etc/hosts  remote_src=yes”</p>
<p><img src="/images/zong%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/1561188862896.png" alt="1561188862896"></p>
<h4 id="第五个模块：文件模块-fetch-（批量拉取文件—拉）-扩展"><a href="#第五个模块：文件模块-fetch-（批量拉取文件—拉）-扩展" class="headerlink" title="第五个模块：文件模块 - fetch  （批量拉取文件—拉） 扩展"></a>第五个模块：文件模块 - fetch  （批量拉取文件—拉） 扩展</h4><p>ansible 172.16.1.31 -m fetch -a “src=/etc/oldgirl.txt dest=/tmp”</p>
<p><img src="/images/zong%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/1561189231829.png" alt="1561189231829"></p>
<h4 id="第六个模块：文件模型-file-（修改文件权限-）"><a href="#第六个模块：文件模型-file-（修改文件权限-）" class="headerlink" title="第六个模块：文件模型 - file （修改文件权限 ）"></a>第六个模块：文件模型 - file （修改文件权限 ）</h4><p>作用：<br>     1. 修改文件权限信息<br>     2. 创建数据信息/删除数据信息</p>
<h5 id="用法：修改文件权限"><a href="#用法：修改文件权限" class="headerlink" title="用法：修改文件权限"></a>用法：修改文件权限</h5><p>ansible 172.16.1.31 -m file -a “path=/etc/oldgirl.txt mode=666 owner=www group=www”</p>
<p><img src="/images/zong%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/1561189366843.png" alt="1561189366843"></p>
<p><img src="/images/zong%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/1561189402973.png" alt="1561189402973"></p>
<h5 id="特殊用法：创建文件-touch"><a href="#特殊用法：创建文件-touch" class="headerlink" title="特殊用法：创建文件 touch"></a>特殊用法：创建文件 touch</h5><p>ansible 172.16.1.7 -m file -a “path=/gurenyun/gurenyun.txt state=touch”</p>
<p><img src="/images/zong%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/1561189505997.png" alt="1561189505997"></p>
<h5 id="特殊用法：创建目录-directory"><a href="#特殊用法：创建目录-directory" class="headerlink" title="特殊用法：创建目录 directory"></a>特殊用法：创建目录 directory</h5><p>ansible 172.16.1.7 -m file -a “path=/gurenyun/gurenyun_dir state=directory”</p>
<p><img src="/images/zong%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/1561189545584.png" alt="1561189545584"></p>
<h5 id="特殊用法：创建硬链接-hard"><a href="#特殊用法：创建硬链接-hard" class="headerlink" title="特殊用法：创建硬链接 hard"></a>特殊用法：创建硬链接 hard</h5><p>ansible 172.16.1.7 -m file -a “src=/gurenyun/gurenyun.txt path=/gurenyun/gurenyun_dir/gurenyun_hard_link  state=hard”</p>
<p><img src="/images/zong%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/1561189612952.png" alt="1561189612952"></p>
<p><img src="/images/zong%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/1561189661592.png" alt="1561189661592"></p>
<h5 id="特殊用法：创建软链接-ink"><a href="#特殊用法：创建软链接-ink" class="headerlink" title="特殊用法：创建软链接 ink"></a>特殊用法：创建软链接 ink</h5><p>ansible 172.16.1.7 -m file -a “src=/gurenyun/gurenyun.txt path=/gurenyun/gurenyun_dir/gurenyun_soft_link  state=link”</p>
<p><img src="/images/zong%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/1561189716858.png" alt="1561189716858"></p>
<p><img src="/images/zong%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/1561189733683.png" alt="1561189733683"></p>
<h5 id="特殊用法：删除文件数据-absent"><a href="#特殊用法：删除文件数据-absent" class="headerlink" title="特殊用法：删除文件数据 absent"></a>特殊用法：删除文件数据 absent</h5><p>ansible 172.16.1.7 -m file -a “path=/gurenyun/gurenyun_dir/gurenyun_soft_link  state=absent”</p>
<p><img src="/images/zong%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/1561189772023.png" alt="1561189772023"></p>
<h4 id="第七个模块：-cron-定时任务模块"><a href="#第七个模块：-cron-定时任务模块" class="headerlink" title="第七个模块： cron 定时任务模块"></a>第七个模块： cron 定时任务模块</h4><ol>
<li><p>cron定时模块作用：批量添加设置定时任务信息</p>
</li>
<li><p>cron定时模块格式：</p>
</li>
</ol>
<p>​     *          *         *         *        *                    定时任务 &amp;&gt;/dev/null</p>
<p>​    分        时      日       月      周      </p>
<p>minute   hour   day  month   weekday      job=’任务信息’&amp;&gt;/dev/null’</p>
<p>​    3.参数：<br>​    minute  hour   day   month  weekday  — 时间参数<br>​    job     – 指定定时任务信息<br>​    name    – 添加注释信息<br>​    state   – absent 删除定时任务 present 添加定时任务<br>​    disabled   – 注释定时任务 yes  取消定时任务注释 no</p>
<p>批量编写定时任务： 每隔5分钟，时间同步</p>
<p>ansible backup -m cron -a “name=’date ntpdate crond02’  minute=*/5 job=’ntpdate ntp1.aliyun.com &amp;&gt;/dev/null’”</p>
<p><img src="/images/zong%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/1561193163514.png" alt="1561193163514"></p>
<p>批量删除定时任务信息：</p>
<p>ansible backup -m cron -a “name=’date ntpdate crond’ state=absent”</p>
<p><img src="/images/zong%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/1561193119378.png" alt="1561193119378"></p>
<p>批量注释定时任务信息：</p>
<p> ansible backup -m cron -a “name=’date ntpdate crond’  minute=*/5 job=’ntpdate ntp1.aliyun.com &amp;&gt;/dev/null’ disabled=yes”</p>
<p><img src="/images/zong%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/1561193262094.png" alt="1561193262094"></p>
<h4 id="第八个模块：yum-批量下载安装软件"><a href="#第八个模块：yum-批量下载安装软件" class="headerlink" title="第八个模块：yum 批量下载安装软件"></a>第八个模块：yum 批量下载安装软件</h4><p>作用：安装部署软件<br>参数：<br>    name：  指定软件名称<br>    state： 指定动作信息  installed </p>
<p>yum批量安装：</p>
<p>ansible backup -m yum -a “name=nmap state=installed”</p>
<p><img src="/images/zong%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/1561193438126.png" alt="1561193438126"></p>
<h4 id="第九个模块：service-管理服务状态模块"><a href="#第九个模块：service-管理服务状态模块" class="headerlink" title="第九个模块：service 管理服务状态模块"></a>第九个模块：service 管理服务状态模块</h4><p>作用：批量启动/停止服务程序  设置服务是否开机自动启动<br>参数：<br>    name：   定义服务名称<br>    state：  是否启动 started 停止 stopped 重启 restarted 平滑重启 reloaded<br>    enabled：设置服务是否开机自动启动 </p>
<p>设置服务启动/停止：</p>
<p>ansible backup -m service -a “name=firewalld state=started enabled=yes”<br>    ansible backup -m service -a “name=firewalld state=stopped enabled=no”</p>
<h4 id="第九个模块：user-用户管理模块"><a href="#第九个模块：user-用户管理模块" class="headerlink" title="第九个模块：user  用户管理模块"></a>第九个模块：user  用户管理模块</h4><p>作用  创建用户信息<br>参数<br>    name  创建的用户名称<br>    uid   指定用户的uid信息<br>    group    指定属于主要组<br>    groups   指定属于哪个附属组<br>    password 设置用户密码信息？？？<br>    shell    指定登录方式 /bin/bash  /sbin/nologin<br>    create_home：创建虚拟用户：</p>
<p>创建虚拟用户：</p>
<p>ansible backup -m user -a “name=gedage. uid=666 group=root groups=gurenyun shell=/sbin/nologin create_home=no”</p>
<p><img src="/images/zong%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/1561193864687.png" alt="1561193864687"></p>
<p>设置用户密码：</p>
<p>PS：密码信息必须是加密的</p>
<p>第一步先生成加密密码。</p>
<p>第二步复制加密密码 放入命令中。</p>
<p>方法一: </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ansible all -i localhost, -m debug -a &quot;msg=&#123;&#123; &apos;mypassword&apos; | password_hash(&apos;sha512&apos;, &apos;mysecretsalt&apos;) &#125;&#125;&quot;</span><br><span class="line">	mypassword   	--- 明文密码信息</span><br><span class="line">	sha512       	--- 明文转换为密文加密方法</span><br><span class="line">	mysecretsalt 	--- 用什么做算法依据生成密文信息</span><br></pre></td></tr></table></figure>

<p>实例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible all -i localhost, -m debug -a &quot;msg=&#123;&#123; &apos;gurenyun123&apos; | password_hash(&apos;sha512&apos;, &apos;oldgirl&apos;) &#125;&#125;&quot;</span><br></pre></td></tr></table></figure>

<p><img src="/images/zong%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/1561201862679.png" alt="1561201862679"></p>
<p>​    复制加密密码 放入命令行 password= 后生成用户加密密码。</p>
<p>ansible backup -m user -a ‘name=Alex02 password=”$6$oldgirl$kAUTXVC2z1agr1HlmpFe9abFhWKwJ1fNyg64F95U3rVumwQfqOuhV3YkyZU9.H79TChzIKn5epl5M18B199qV1”‘</p>
<p>ps：注意加密密码必须加双引号。</p>
<p>可以再  /etc/shadow 中查看加密密码。</p>
<p>方法二：</p>
<p> 在centos7中无法使用<br>mkpasswd –method=sha-512</p>
<p>方法三:  利用python模块功能<br>    yum install python-pip<br>    pip install passlib<br>    python -c “from passlib.hash import sha512_crypt; import getpass; print(sha512_crypt.using(rounds=5000).hash(getpass.getpass()))”</p>
<p>复制加密密码 放入命令行 password= 后生成用户加密密码。</p>
<p>ansible backup -m user -a ‘name=Alex02 password=”$6$oldgirl$kAUTXVC2z1agr1HlmpFe9abFhWKwJ1fNyg64F95U3rVumwQfqOuhV3YkyZU9.H79TChzIKn5epl5M18B199qV1”‘</p>
<p>补充：pip优化</p>
<p><img src="/images/zong%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/1561202519249.png" alt="1561202519249"></p>
<p><img src="/images/zong%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/1561202524554.png" alt="1561202524554"></p>
<p><img src="C:%5CUsers%5CAdministrator%5CDesktop%5CQQ%E5%9B%BE%E7%89%8720190622192244.png" alt="QQ图片20190622192244"></p>
<h4 id="第十个模块：mount-挂载模块"><a href="#第十个模块：mount-挂载模块" class="headerlink" title="第十个模块：mount  挂载模块"></a>第十个模块：mount  挂载模块</h4><p>作用：实现批量挂载操作<br>参数：<br>    src    ：需要挂载存储设备信息<br>    path   : 挂载点路径信息<br>    fstype ：挂载类型信息<br>    state  ：挂载操作（mounted present）/卸载操作（unmounted absent）<br>             mounted： 可以实现立即挂载  永久开机自动挂载<br>             present：                   永久开机自动挂载<br>             unmounted： 可以实现立即卸载<br>             absent：    可以实现立即卸载  永久卸载</p>
<p>批量挂载操作：</p>
<p>ansible 172.16.1.7 -m mount -a “src=172.16.1.31:/data path=/mnt fstype=nfs state=mounted”</p>
<p><img src="/images/zong%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/1561202923888.png" alt="1561202923888"></p>
<h2 id="六、利用剧本功能完成服务程序一键化部署"><a href="#六、利用剧本功能完成服务程序一键化部署" class="headerlink" title="六、利用剧本功能完成服务程序一键化部署"></a>六、利用剧本功能完成服务程序一键化部署</h2><h4 id="1-编写脚本："><a href="#1-编写脚本：" class="headerlink" title="1.编写脚本："></a>1.编写脚本：</h4><p>​    实操：一键化部署rsync服务：ansible命令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">rsync服务部署流程：</span><br><span class="line">服务端部署：</span><br><span class="line">01. 安装软件程序</span><br><span class="line">    ansible 172.16.1.41 -m yum -a &quot;name=rsync state=installed&quot;</span><br><span class="line">02. 编写配置文件</span><br><span class="line">    ansible 172.16.1.41 -m copy -a &quot;src=/etc/rsyncd.conf dest=/etc/&quot;</span><br><span class="line">03. 创建虚拟用户</span><br><span class="line">    ansible 172.16.1.41 -m user -a &quot;name=rsync shell=/sbin/nologin create_home=no&quot;</span><br><span class="line">04. 创建密码文件，并修改权限</span><br><span class="line">    ansible 172.16.1.41 -m copy -a &quot;content=&apos;rsync_backup:gurenyun123&apos; dest=/etc/rsync.password mode=600&quot;</span><br><span class="line">05. 创建备份目录，并修改权限</span><br><span class="line">    ansible 172.16.1.41 -m file -a &quot;path=/backup state=directory owner=rsync group=rsync&quot;</span><br><span class="line">06. 启动程序服务</span><br><span class="line">    ansible 172.16.1.41 -m service -a &quot;name=rsyncd state=restarted enabled=yes&quot;</span><br><span class="line"></span><br><span class="line">客户端部署：</span><br><span class="line">01. 安装软件程序 </span><br><span class="line">    ansible rsync_client -m yum -a &quot;name=rsync state=installed&quot;</span><br><span class="line">02. 创建密码文件，并修改权限 </span><br><span class="line">    ansible rsync_client -m copy -a &quot;content=&apos;gurenyun123&apos; dest=/etc/rsync.password mode=600&quot;</span><br></pre></td></tr></table></figure>

<p><img src="/images/zong%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/1561203551230.png" alt="1561203551230"></p>
<p><img src="/images/zong%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/1561203558191.png" alt="1561203558191"></p>
<h4 id="2-编写剧本"><a href="#2-编写剧本" class="headerlink" title="2.编写剧本"></a>2.编写剧本</h4><p>模块–命令<br>    剧本–脚本：汇总多个模块的批量操作<br>    剧本如何编写： python yaml 语法规范</p>
<p>三种规范原则：<br>空格：  缩进信息  两个空格<br>        PS：编写剧本时，将tab键扣掉<br>冒号：  key-value（键值关系）  hosts: 172.16.1.41<br>        冒号后面不需要有空格情况：<br>        01. 以冒号结尾<br>        02. 冒号信息出现在注释信息中<br>短横线：- 生成列表信息  </p>
<ul>
<li>hosts: 172.16.1.41</li>
<li>hosts: 172.16.1.31</li>
</ul>
<h5 id="剧本内容编写："><a href="#剧本内容编写：" class="headerlink" title="剧本内容编写："></a>剧本内容编写：</h5><p>创建剧本存放目录：mkdir /etc/ansible/ansible_playbook<br>编写剧本：vim /etc/ansible/ansible_playbook/test.yaml</p>
<h5 id="剧本执行方法："><a href="#剧本执行方法：" class="headerlink" title="剧本执行方法："></a>剧本执行方法：</h5><ol>
<li><p>检查剧本语法信息</p>
<p>ansible-playbook –syntax-check test.yaml </p>
<p><img src="/images/zong%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/1561203869582.png" alt="1561203869582"></p>
<p>出现playbook: test.yaml  即剧本测试没问题。</p>
</li>
<li><p>剧本模拟执行</p>
<pre><code>ansible-playbook -C test.yaml</code></pre></li>
<li><p>真实执行剧本</p>
<pre><code>ansible-playbook  test.yaml</code></pre></li>
</ol>
<h5 id="常见问题："><a href="#常见问题：" class="headerlink" title="常见问题："></a>常见问题：</h5><ol>
<li><p>如果安装了cowsay</p>
<pre><code>vim /etc/ansible/ansible.cfg
nocows = 1</code></pre><p><img src="/images/zong%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/1561203976866.png" alt="1561203976866"></p>
</li>
</ol>
<h4 id="3-一键化剧本编写"><a href="#3-一键化剧本编写" class="headerlink" title="3.一键化剧本编写"></a>3.一键化剧本编写</h4><p>示例：rsync服务程序一键化剧本</p>
<p>第一个历程：修改主机清单</p>
<p>ex：   [rsync_client]<br>          172.16.1.7<br>          172.16.1.31</p>
<p>第二个历程：创建所需分发文件</p>
<p>ex：/etc/ansible/ansible_playbook/rsyncd.conf </p>
<p>第三个历程：编写剧本文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">vim rsync_auto.yaml </span><br><span class="line">    - hosts: 172.16.1.41</span><br><span class="line">      tasks:</span><br><span class="line">        - name: 01:install rsync software</span><br><span class="line">          yum: name=rsync state=installed</span><br><span class="line">        - name: 02:push client</span><br><span class="line">          copy: src=./rsyncd.conf dest=/etc/</span><br><span class="line">        - name: 03:create user</span><br><span class="line">          user: name=rsync shell=/sbin/nologin create_home=no</span><br><span class="line">        - name: 04:create password file</span><br><span class="line">          copy: content=&apos;rsync_backup:gurenyun123&apos; dest=/etc/rsync.password mode=600</span><br><span class="line">        - name: 05:create backup dir</span><br><span class="line">          file: path=/backup state=directory owner=rsync group=rsync</span><br><span class="line">        - name: 06:重启rsync服务</span><br><span class="line">          service: name=rsyncd state=restarted enabled=yes  </span><br><span class="line">    </span><br><span class="line">    - hosts: rsync_client</span><br><span class="line">      tasks:</span><br><span class="line">        - name: 01:ceate password file</span><br><span class="line">          copy: content=&apos;gurenyun123&apos; dest=/etc/rsync.password mode=600</span><br></pre></td></tr></table></figure>

<p>第四个历程：测试剧本功能</p>
<p>附：nfs服务程序一键化剧本</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">vim nfs_auto.yaml</span><br><span class="line">- hosts: 10.0.0.31</span><br><span class="line">  tasks:</span><br><span class="line">    - name: 01:安装软件</span><br><span class="line">      yum: name=rpcbind name=nfs-utils  state=installed</span><br><span class="line">    - name: 02:配置文件</span><br><span class="line">      copy: content=&apos;/data    172.16.1.0/24(rw,sync,anonuid=1002,anongid=1002,no_all_squash,root_squash)&apos; dest=/etc/exports</span><br><span class="line">    - name: 创建data目录</span><br><span class="line">      file: path=/data state=directory owner=www group=www</span><br><span class="line">    - name: 04:重启rpc服务</span><br><span class="line">      service: name=rpcbind state=restarted enabled=yes</span><br><span class="line">    - name: 05:重启nfs服务</span><br><span class="line">      service: name=nfs state=restarted enabled=yes</span><br><span class="line"></span><br><span class="line">- hosts: nfs_client</span><br><span class="line">  tasks:</span><br><span class="line">    - name: 01:安装软件</span><br><span class="line">      yum: name=rpcbind name=nfs-utils  state=installed</span><br><span class="line">    - name: 挂载</span><br><span class="line">      mount: src=172.16.1.31:/data path=/mnt fstype=nfs state=mounted</span><br></pre></td></tr></table></figure>

<p><img src="/images/zong%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/1561204284074.png" alt="1561204284074"></p>
<h2 id="八、数据实时同步备份"><a href="#八、数据实时同步备份" class="headerlink" title="八、数据实时同步备份"></a>八、数据实时同步备份</h2><h3 id="1-概念说明："><a href="#1-概念说明：" class="headerlink" title="1.概念说明："></a>1.概念说明：</h3><p>​    定时同步备份数据：缺点，备份的周期最短为1分钟   企业内部人员数据<br>​    实时同步备份数据：数据同步备份效率高            用户外部人员数据</p>
<h3 id="2-同步原理："><a href="#2-同步原理：" class="headerlink" title="2.同步原理："></a>2.同步原理：</h3><p>​    01. 发现指定目录数据有变化   inotify<br>​    02. 将变化数据进行传输备份   rsync<br>​    03. 利用脚本实现实时同步     while循环（条件判断）-&gt; sersync</p>
<h3 id="3-实时监控软件inotify"><a href="#3-实时监控软件inotify" class="headerlink" title="3.实时监控软件inotify"></a>3.实时监控软件inotify</h3><pre><code>1）监控软件安装部署
yum install -y inotify-tools   -- epel源
2）软件命令应用
rpm -ql inotify-tools
rpm -qc 服务           --- 查看服务程序配置文件保存路径

inotifywait            --- 监控目录变化的数据信息
inotifywatch           --- 监控变化事件次数
监控事件信息：增加信息  删除信息  修改信息  移动数据</code></pre><h4 id="1-inotifywait参数说明："><a href="#1-inotifywait参数说明：" class="headerlink" title="1)inotifywait参数说明："></a>1)inotifywait参数说明：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">--exclude &lt;pattern&gt;    --- 排除指定数据信息，不做实时同步</span><br><span class="line">	--excludei &lt;pattern&gt;   --- 排除指定数据信息（数据信息忽略大小写），不做实时同步</span><br><span class="line">	-m|--monitor           --- 实时一直进行监控（默认只监控一次）</span><br><span class="line">	-r|--recursive	       --- 递归监控目录</span><br><span class="line">	--format &lt;fmt&gt;	       --- 设置监控输出信息的格式 （了解）</span><br><span class="line">    --timefmt &lt;fmt&gt;        --- 时间格式设定</span><br><span class="line">    -e|--event	           --- 指定监控事件  （只监控目录中是否有新的数据创建）</span><br><span class="line">	-q|--quiet    	       --- 减少命令输出的信息</span><br></pre></td></tr></table></figure>

<h4 id="2-inotify事件信息："><a href="#2-inotify事件信息：" class="headerlink" title="2)inotify事件信息："></a>2)inotify事件信息：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">access		      file or directory contents were read</span><br><span class="line">	                  文件数据内容被读取</span><br><span class="line">    modify		      file or directory contents were written</span><br><span class="line">	                  文件数据内容被写入</span><br><span class="line">    attrib		      file or directory attributes changed</span><br><span class="line">	                  文件数据属性被修改</span><br><span class="line">    close_write	      file or directory closed, after being opened in writeable mode</span><br><span class="line">	                  文件或目录被关闭，在文件被修改后</span><br><span class="line">    close_nowrite	  file or directory closed, after being opened in read-only mode</span><br><span class="line">	                  文件或目录被关闭，在文件没有被改动后</span><br><span class="line">    close		      file or directory closed, regardless of read/write mode</span><br><span class="line">	                  文件或目录被关闭，无论编写或者未修改</span><br><span class="line">    open		      file or directory opened</span><br><span class="line">	                  文件被打开</span><br><span class="line">    moved_to	      file or directory moved to watched directory</span><br><span class="line">	                  文件或目录移动到监控目录中</span><br><span class="line">    moved_from	      file or directory moved from watched directory</span><br><span class="line">	                  文件或目录从监控目录中移出</span><br><span class="line">    move		      file or directory moved to or from watched directory</span><br><span class="line">	                  文件或目录被移动了</span><br><span class="line">    create		      file or directory created within watched directory</span><br><span class="line">	                  文件或目录在指定监控目录中进行创建</span><br><span class="line">    delete		      file or directory deleted within watched directory</span><br><span class="line">	                  文件或目录在指定监控目录中进行删除</span><br></pre></td></tr></table></figure>

<h4 id="3-实践操作演示："><a href="#3-实践操作演示：" class="headerlink" title="3) 实践操作演示："></a>3) 实践操作演示：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@nfs01 data]# inotifywait -mrq --timefmt &apos;%d/%m/%y %H:%M&apos; --format &apos;%T %w%f 事件:%e&apos;  /data</span><br><span class="line">   24/06/19 09:41 /data/gurenyun06.txt 事件:CREATE</span><br><span class="line">   24/06/19 09:41 /data/gurenyun06.txt 事件:OPEN</span><br><span class="line">   24/06/19 09:41 /data/gurenyun06.txt 事件:ATTRIB</span><br><span class="line">   24/06/19 09:41 /data/gurenyun06.txt 事件:CLOSE_WRITE,CLOSE</span><br><span class="line"></span><br><span class="line">sed命令替换修改内容</span><br><span class="line">24/06/19 09:44 /data/gurenyun01.txt 事件:OPEN    打开源文件信息</span><br><span class="line">   24/06/19 09:44 /data/sedLDr3BA 事件:CREATE     创建一个临时文件</span><br><span class="line">   24/06/19 09:44 /data/sedLDr3BA 事件:OPEN       将临时文件打开</span><br><span class="line">   24/06/19 09:44 /data/gurenyun01.txt 事件:ACCESS  访问源文件信息</span><br><span class="line">   24/06/19 09:44 /data/sedLDr3BA 事件:MODIFY     修改临时文件</span><br><span class="line">   24/06/19 09:44 /data/sedLDr3BA 事件:ATTRIB     修改临时文件属性</span><br><span class="line">   24/06/19 09:44 /data/gurenyun01.txt 事件:CLOSE_NOWRITE,CLOSE   源文件不做任何改动</span><br><span class="line">   24/06/19 09:44 /data/sedLDr3BA 事件:CLOSE_WRITE,CLOSE        临时文件修改完毕保存</span><br><span class="line">   24/06/19 09:44 /data/sedLDr3BA 事件:MOVED_FROM               临时文件进行重命名操作             </span><br><span class="line">   24/06/19 09:44 /data/gurenyun01.txt 事件:MOVED_TO</span><br></pre></td></tr></table></figure>

<p><img src="/images/zong%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/9999.png" alt="img"></p>
<h4 id="4-脚本如何实现实时同步："><a href="#4-脚本如何实现实时同步：" class="headerlink" title="4)脚本如何实现实时同步："></a>4)脚本如何实现实时同步：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">    inotifywait /data -mrq --format &apos;%w%f&apos; -e &quot;modify,close_write,move,create,delete&quot;|\</span><br><span class="line">    while read line	</span><br><span class="line">    do</span><br><span class="line">       #将数据进行推送</span><br><span class="line">       rsync -avz --delete /data/  rsync_backup@172.16.1.41::backup --password-file=/etc/rsync.password</span><br><span class="line">    done</span><br><span class="line">      #将数据进行推送</span><br><span class="line">       rsync -avz --delete /data/  rsync_backup@172.16.1.41::backup --password-file=/etc/rsync.password</span><br><span class="line">    done</span><br></pre></td></tr></table></figure>

<h4 id="5-停止脚本"><a href="#5-停止脚本" class="headerlink" title="5)停止脚本"></a>5)停止脚本</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">脚本执行，有可能停不下来</span><br><span class="line">	    crtl+z ---&gt; 暂停脚本 </span><br><span class="line">		如何停止脚本进程</span><br><span class="line">		kill -9  强制停止脚本</span><br><span class="line">		kill 进程       --- 停止进程</span><br><span class="line">		killall  进程名 --- 停止进程，进程停止后会有提示</span><br><span class="line">		pkill    进程名 --- 停止进程，模糊的杀手（sh），进程停止后没有提示</span><br><span class="line">	    fg --     将进程放入前台</span><br><span class="line">	    </span><br><span class="line">脚本放入后台运行：（脚本运行，远程关闭，脚本即停止）</span><br><span class="line">sh inotify.sh &amp;  --- 将脚本放入后台运行</span><br></pre></td></tr></table></figure>

<h4 id="6）-inotify服务优化说明"><a href="#6）-inotify服务优化说明" class="headerlink" title="6） inotify服务优化说明"></a>6） inotify服务优化说明</h4><p>在/proc/sys/fs/inotify/目录下有三个文件，对inotify机制有一定的限制<br>    max_queued_events：    设置inotifywait或inotifywatch命令可以监视的文件数量（单进程）<br>    327679<br>    max_user_instances: 设置每个用户可以运行inotifywait或inotifywatch命令进程数<br>    128<br>    max_user_watches：    设置inotify实例事件(event)队列可容纳的事件数量<br>    root —/data   gurenyun01.txt  — create事件<br>    root —/data   gurenyun02.txt  — create事件    – 内存<br>    gurenyun —/data   gurenyun03.txt  — delete事件  – 内存<br>    50000000</p>
<h3 id="4-实现实时同步：sersync软件"><a href="#4-实现实时同步：sersync软件" class="headerlink" title="4.实现实时同步：sersync软件"></a>4.实现实时同步：sersync软件</h3><h4 id="1）sersync软件下载安装"><a href="#1）sersync软件下载安装" class="headerlink" title="1）sersync软件下载安装"></a>1）sersync软件下载安装</h4><p>  — 二进制（解压后直接使用）<br>       官方资料：<a href="https://github.com/wsgzao/sersync" target="_blank" rel="noopener">https://github.com/wsgzao/sersync</a><br>       mkdir /server/tools<br>       unzip sersync_installdir_64bit.zip<br>       cd sersync_installdir_64bit/<br>       mv sersync/ /usr/local/</p>
<h4 id="2）编写sersync服务配置文件"><a href="#2）编写sersync服务配置文件" class="headerlink" title="2）编写sersync服务配置文件"></a>2）编写sersync服务配置文件</h4><p> cd /usr/local/sersync/conf<br>       vim confxml.xml</p>
 <debug start="true">
       说明：将参数改为true，表示显示sersync程序执行过程

<p><img src="/images/zong%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/1561383715922.png" alt="1561383715922"></p>
<p>说明：排除指定信息不需要进行同步</p>
<p><img src="/images/zong%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/1561383744692.png" alt="1561383744692"></p>
<p>说明：指定监控事件信息</p>
<p><img src="/images/zong%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/1561383959609.png" alt="1561383959609"></p>
<p><img src="/images/zong%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/123.png" alt></p>
<p>配置指向信息</p>
<h4 id="3）sersync服务如何启动"><a href="#3）sersync服务如何启动" class="headerlink" title="3）sersync服务如何启动"></a>3）sersync服务如何启动</h4><p>cd /usr/local/sersync/bin/<br>       chmod a+x sersync<br>       /usr/local/sersync/bin/sersync -help    （-help –help -h –h man sersync）<br>       参数信息：<br>       -d（daemon）  — 让服务以守护进程方式运行<br>       -r            — 递归复制同步数据<br>       -o            — 读取加载指定同步文件<br>           -o 配置文件（confxml.xml）  — watch “/data”  — /usr/local/sersync/conf/confxml.xml<br>           -o 配置文件（confxml01.xml）— watch “/data01”— /usr/local/sersync/conf/confxml01.xml</p>
<pre><code>启动命令
sersync -dro  /usr/local/sersync/conf/confxml.xml</code></pre><h3 id="5-配置lsync服务"><a href="#5-配置lsync服务" class="headerlink" title="5.配置lsync服务"></a>5.配置lsync服务</h3><p>1.下载lsyncd</p>
<p> yum -y install lsyncd</p>
<p>2.修改配置文件</p>
<p>vim /etc/lsyncd.conf</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">settings &#123;</span><br><span class="line"> logfile = &quot;/var/log/lsyncd/lsyncd.log&quot;,</span><br><span class="line"> statusFile = &quot;/var/log/lsyncd/lsyncd.status&quot;,</span><br><span class="line"> inotifyMode = &quot;CloseWrite&quot;,</span><br><span class="line"> maxProcesses = 8,</span><br><span class="line">&#125;</span><br><span class="line">sync &#123;</span><br><span class="line"> default.rsync,</span><br><span class="line"> source = &quot;/data&quot;,</span><br><span class="line"> target = &quot;rsync_backup@172.16.1.41::backup&quot;,</span><br><span class="line"> delete= true,</span><br><span class="line"> exclude = &#123; &quot;.*&quot; &#125;,</span><br><span class="line"> delay = 1,</span><br><span class="line">rsync = &#123;</span><br><span class="line"> binary = &quot;/usr/bin/rsync&quot;,</span><br><span class="line"> archive = true,</span><br><span class="line"> compress = true,</span><br><span class="line"> verbose = true,</span><br><span class="line"> password_file = &quot;/etc/rsync.password&quot;,</span><br><span class="line"> _extra = &#123;&quot;--bwlimit=200&quot;&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>3.启动服务</p>
<p>systemctl start lsyncd</p>
<h2 id="九、综合架构网站服务原理"><a href="#九、综合架构网站服务原理" class="headerlink" title="九、综合架构网站服务原理"></a>九、综合架构网站服务原理</h2><h3 id="1-用户访问网站的原理过程："><a href="#1-用户访问网站的原理过程：" class="headerlink" title="1.用户访问网站的原理过程："></a>1.用户访问网站的原理过程：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">   00. 用户输入域名点击回车</span><br><span class="line">01. 完成域名DNS解析过程      DNS原理</span><br><span class="line">02. 完成TCP三次握手建立</span><br><span class="line">03. 向网站服务器访问请求信息（HTTP请求）</span><br><span class="line">   03.5. 网站架构接收用户请求    （负载均衡 web集群 存储 数据库 缓存...）</span><br><span class="line">04. 向客户端响应数据信息    （HTTP响应）</span><br><span class="line">05. 用户利用浏览器解析响应信息，显示最终页面</span><br><span class="line">06. 完成TCP四次挥手过程</span><br></pre></td></tr></table></figure>

<h3 id="2-用户访问网站HTTP协议原理"><a href="#2-用户访问网站HTTP协议原理" class="headerlink" title="2.用户访问网站HTTP协议原理"></a>2.用户访问网站HTTP协议原理</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">什么是HTTP：超文本传输协议</span><br><span class="line">	HTTP协议请求：报文结构  4个部分</span><br><span class="line">	1）请求行：    标题       1行</span><br><span class="line">	   请求方法：get（获取） post（提交）</span><br><span class="line">	   请求内容：默认index.html(首页文件)</span><br><span class="line">	   协议版本：HTTP1.0  HTTP1.1  HTTP2.0(高并发访问效率更高)</span><br><span class="line">	     TCP协议长连接和短连接概念：</span><br><span class="line">	     短连接：一次连接 一次请求</span><br><span class="line">	     长连接：一次连接 多次请求</span><br><span class="line">	2）请求头：    中心思想   多行 </span><br><span class="line">	   请求主机信息： 根据请求主机信息显示不同页面  www bbs blog</span><br><span class="line">	   请求user-agent信息：打开手机---腾讯浏览器APP---设置---浏览器UA:iphone</span><br><span class="line">	3）空行        </span><br><span class="line">	4）请求主体：  详细说明内容  多行</span><br><span class="line">	   使用get方法：没有请求主体</span><br><span class="line">	   使用post方法：产生请求主体（提交的信息 用户注册信息  用户登录信息） ？？？</span><br><span class="line">	</span><br><span class="line">	HTTP协议响应：报文结构  4个部分</span><br><span class="line">	1）响应行：</span><br><span class="line">	   响应状态码：响应结果  面试题</span><br><span class="line">	   200 OK    --- 正常结果信息</span><br><span class="line">	   301       --- 跳转 永久跳转   </span><br><span class="line">	   302       --- 跳转 临时跳转</span><br><span class="line">	   401       --- 认证失败了</span><br><span class="line">	   403       --- 用户禁止访问 爬虫  iptables</span><br><span class="line">	             --- 网站首页文件不存在</span><br><span class="line">	   404       --- 你访问的页面不存在 </span><br><span class="line">	                 网站服务端会进行优雅显示</span><br><span class="line">	   5xx       --- 网站架构服务有关     </span><br><span class="line">	2）响应头部：</span><br><span class="line">	   响应的服务程序：web服务程序名称  nginx/tenginx/bfe/apache  </span><br><span class="line">	3）空行 </span><br><span class="line">	4）响应主体：</span><br><span class="line">	   请求响应过来的代码信息：html代码信息</span><br></pre></td></tr></table></figure>

<h3 id="3-HTTP协议资源"><a href="#3-HTTP协议资源" class="headerlink" title="3.HTTP协议资源"></a>3.HTTP协议资源</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">媒体资源类型：mime.types 媒体资源类型文件</span><br><span class="line">媒体资源类型文件中有的信息：会直接解析，显示页面</span><br><span class="line">媒体资源类型文件没有的信息：会进行下载，不会解析</span><br><span class="line"></span><br><span class="line">访问网站地址类型：</span><br><span class="line">www.gurenyun.com      /gurenyun.jj</span><br><span class="line">    url              uri       </span><br><span class="line">url: 全称为Uniform Resource Location，中文翻译为统一资源定位符，也被称为网页地址</span><br><span class="line">uri: 全称为Uniform Resource Identifier，中文翻译为统一资源标识符，是一个用于标识某一互联网资源名称的字符串</span><br><span class="line">   </span><br><span class="line">访问资源分类：</span><br><span class="line">   静态资源： 所见即所得  见到的代码是什么样，浏览器解析就会解析成什么页面</span><br><span class="line">   1)	访问资源uri扩展名信息</span><br><span class="line">    每个页面都有一个固定的URL地址，且URI一般以.html、.htm、.shtml等常见形式为后缀，而且地址中不含有问号“？”或“&amp;”等特殊符号。</span><br><span class="line">   2)	网页内容一经发布到网站服务器上，无论是否有用户访问，每个网页的内容都是保存在网站服务器文件系统上的，也就是说，静态网页是实实在在保存在服务器上的文件实体，每个网页都是一个独立的文件。</span><br><span class="line">  *3)	网页内容是固定不变的，因此，容易被搜索引擎收录（容易被用户找到）（优点）。</span><br><span class="line">   4)	因为网页没有数据库的支持，所以在网站制作和维护方面的工作量较大，当网站信息量很大时，完全依靠静态网页比较困难（缺点）。</span><br><span class="line">   5)	网页的交互性较差，在程序的功能实现方面有较大的限制（缺点）。</span><br><span class="line">  *6)	网页程序在用户浏览器端解析，如IE浏览器，程序解析效率很高，由于服务器端不进行解析，并且不需要读取数据库，因此服务器端可以接受更多的并发访问。当客户端向服务器请求数据时，服务器会直接从磁盘文件系统上返回数据（不做任何解析）。待客户端拿到数据后，在浏览器端解析并展现出来（优点）。</span><br><span class="line">       用户请求 --- web服务器 -- index.html  gurenyun.html gurenyun.jpg --- 用户</span><br><span class="line">  </span><br><span class="line">   动态资源： 会调取数据库资源，显示页面信息</span><br><span class="line">   1)	网页扩展名后缀常见为：.asp、.aspx、.php、.js、.do、.cgi等。	※</span><br><span class="line">  *2)	网页一般以数据库技术为基础，大大降低了网站维护的工作量。	</span><br><span class="line">  *3)	采用动态网页技术的网站可以实现更多的功能，如用户注册、用户登录、在线调查、投票、用户管理、订单处理、发博文等。</span><br><span class="line">  *4)	动态网页并不是独立存在于服务器上的网页文件，当用户请求服务器上的动态程序时，服务器解析这些程序并可能通过读取数据库来返回一个完整的网页内容。</span><br><span class="line">   5)	动态网页中的“？”在搜索引擎的收录方面存在一定的问题，搜索引擎一般不会从一个网站的数据库中访问全部网页，或者出于技术等方面的考虑，搜索蜘蛛一般不会去抓取网址中“？”后面的内容，因此在企业通过搜索引擎进行推广时，需要针对采用动态网页的网站做一定的技术处理（伪静态技术），以便适应搜索引擎的抓取要求。</span><br><span class="line">6)  动态资源需要和数据进行交互，网页面显示效率较低</span><br><span class="line">    用户请求 ---  web服务器 --- gurenyun.php  ---&gt; php服务处理    --&gt; 数据库  --- php --- web --- 用户 </span><br><span class="line">	用户请求 ---  web服务器 --- gurenyun.js   ---&gt; tomcat服务处理 --&gt; 数据库</span><br><span class="line">   </span><br><span class="line">   伪静态资源：</span><br><span class="line">   1）有数据库支持，可以进行交互</span><br><span class="line">   2）便于被搜索引擎收录</span><br></pre></td></tr></table></figure>

<h3 id="4-网站度量方式：面试题"><a href="#4-网站度量方式：面试题" class="headerlink" title="4.网站度量方式：面试题"></a>4.网站度量方式：面试题</h3><p> IP：根据用户访问的源IP地址  awk数组  ELK—access.log(记录用户源IP地址（公网IP地址）)<br>    参考数据值：192.168（南方 10万）  10.0.0（北方 1万）  彩票<br>    PV: 页面访问量<br>    参考数据值：用户点击网站页面的数量<br>    UV：记录独立用户访客数量<br>    cookie： 钥匙  会员卡      网站给用户分配身份标识信息，保存在主机本地<br>    session：锁头  会员登记表  网站产生的用户访问记录信息，保存在网站服务器中<br>    程序代码进行统计<br>    度量数值参考：<a href="http://alexa.chinaz.com/alexa_more.aspx" target="_blank" rel="noopener">http://alexa.chinaz.com/alexa_more.aspx</a></p>
<p>​    数据专家全站分析： <a href="https://www.umeng.com" target="_blank" rel="noopener">https://www.umeng.com</a></p>
<h3 id="5-企业网站常见web服务"><a href="#5-企业网站常见web服务" class="headerlink" title="5.企业网站常见web服务"></a>5.企业网站常见web服务</h3><p>官方参考：<a href="https://w3techs.com/technologies/overview/web_server/all" target="_blank" rel="noopener">https://w3techs.com/technologies/overview/web_server/all</a><br>    处理静态资源网站：<br>    nginx  web服务软件：<br>    apache web服务软件：zabbix<br>    Tengine<br>    处理动态资源网站<br>    php    web服务软件：<br>    tomcat </p>
<h3 id="6-nginx程序功能介绍"><a href="#6-nginx程序功能介绍" class="headerlink" title="6.nginx程序功能介绍"></a>6.nginx程序功能介绍</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">特点：nginx因具有高并发（特别是静态资源）、占用系统资源少等特性</span><br><span class="line">    功能：nginx程序功能强大</span><br><span class="line">	      1）可以满足web服务应用    apache  蓝汛</span><br><span class="line">		  2）可以满足负载均衡应用   LVS Haproxy</span><br><span class="line">		  3）可以满足缓存应用       Squid</span><br><span class="line">	局限：无法处理动态资源请求</span><br><span class="line">	</span><br><span class="line">	盗链概念：</span><br><span class="line">	  用户访问：           用户访问：</span><br><span class="line">	      |                    |</span><br><span class="line">	      |                    |</span><br><span class="line">	网站A                  网站B</span><br><span class="line">	www.gurenyun.com         www.oldgirl.com</span><br><span class="line">	gurenyun.jpg             index.html</span><br><span class="line">	gurenyun.avi             调用 www.gurenyun.com/gurenyun.jpg </span><br><span class="line">    盗用网站A的资源。</span><br><span class="line">  </span><br><span class="line">    网站服务apache vs nginx</span><br><span class="line">	01. 从特点进行说明</span><br><span class="line">	02. 从功能方面说明</span><br><span class="line">	03. 从软件网络模型   网络编程 socket </span><br><span class="line">	    select：apache  </span><br><span class="line">		事件01: 宿舍管理员  找人---一个一个房间进行查找（遍历）</span><br><span class="line">		事件02：幼儿园阿姨  负责看住小孩上厕所---一个一个进行确认</span><br><span class="line">		epoll： nginx</span><br><span class="line">        事件01: 宿舍管理员  找人---查找名单册</span><br><span class="line">        事件02：幼儿园阿姨  负责看住小孩上厕所---有感觉就站到教室圈里</span><br></pre></td></tr></table></figure>

<h3 id="7-nginx软件部署安装过程"><a href="#7-nginx软件部署安装过程" class="headerlink" title="7.nginx软件部署安装过程"></a>7.nginx软件部署安装过程</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"> 1）利用yum安装软件：</span><br><span class="line">       官方源安装：最新稳定版软件  目录结构信息（企业环境相符）</span><br><span class="line">       其他源安装：稳定版软件	   目录结构信息（企业环境不太相符）  </span><br><span class="line">	</span><br><span class="line">	web01：采用官方源安装</span><br><span class="line">	第一个历程：修改yum源</span><br><span class="line">	官方参考：http://nginx.org/en/linux_packages.html#RHEL-CentOS</span><br><span class="line">	</span><br><span class="line">	[root@web01 ~]# vim /etc/yum.repos.d/nginx.repo</span><br><span class="line">    [nginx-stable]</span><br><span class="line">    name=nginx stable repo</span><br><span class="line">    baseurl=http://nginx.org/packages/centos/$releasever/$basearch/</span><br><span class="line">    gpgcheck=1</span><br><span class="line">    enabled=1</span><br><span class="line">    gpgkey=https://nginx.org/keys/nginx_signing.key</span><br><span class="line">	</span><br><span class="line">	第二个历程：清除yum缓存信息</span><br><span class="line">	yum clean all</span><br><span class="line">	第三个历程：yum安装软件</span><br><span class="line">	yum install -y nginx</span><br><span class="line"></span><br><span class="line">	web02：采用其他源安装</span><br><span class="line">	第一个历程：直接yum安装软件</span><br><span class="line">	yum install -y nginx</span><br><span class="line">	</span><br><span class="line">2）利用编译方式安装：自定义安装功能 自定义程序安装的目录</span><br><span class="line"> 第一步：解决软件依赖关系</span><br><span class="line"> 第二步：进行软件配置过程  配置软件目录  指定软件功能</span><br><span class="line"> 第三步：进行软件编译过程  翻译解释的过程   C-gcc  python-python解释器</span><br><span class="line"> 第四步：进行软件编译安装</span><br><span class="line">	</span><br><span class="line">	web03：编译安装软件</span><br><span class="line">	第一步：下载源码包</span><br><span class="line">	mkdir /server/tools -p</span><br><span class="line">	cd /server/tools</span><br><span class="line">	wget http://nginx.org/download/nginx-1.16.0.tar.gz</span><br><span class="line">	补充：解决软件依赖：</span><br><span class="line">	yum install -y pcre-devel</span><br><span class="line">	说明：pcre-perl兼容正则表达式</span><br><span class="line">	未安装报错信息：</span><br><span class="line">	./configure: error: the HTTP rewrite module requires the PCRE library.</span><br><span class="line">    You can either disable the module by using --without-http_rewrite_module</span><br><span class="line">    option, or install the PCRE library into the system, or build the PCRE library</span><br><span class="line">    statically from the source with nginx by using --with-pcre=&lt;path&gt; option.</span><br><span class="line">	</span><br><span class="line">	yum install -y openssl-devel</span><br><span class="line">	</span><br><span class="line">	说明：openssl-devel 实现支持HTTPs  需要有私钥 公钥（证书）</span><br><span class="line">    未安装报错信息：</span><br><span class="line">    ./configure: error: SSL modules require the OpenSSL library.</span><br><span class="line">    You can either do not enable the modules, or install the OpenSSL library</span><br><span class="line">    into the system, or build the OpenSSL library statically from the source</span><br><span class="line">    with nginx by using --with-openssl=&lt;path&gt; option.</span><br><span class="line"></span><br><span class="line">    yum install -y gcc*</span><br><span class="line">    </span><br><span class="line">    说明：gcc c语言的解释器（nginx -- c语言 python）</span><br><span class="line">    checking for OS</span><br><span class="line">     + Linux 2.6.32-642.el6.x86_64 x86_64</span><br><span class="line">    checking for C compiler ... not found</span><br><span class="line">    </span><br><span class="line">    ./configure: error: C compiler cc is not found</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	第二步：解压源码包</span><br><span class="line">	tar xf nginx-1.16.0.tar.gz</span><br><span class="line">	</span><br><span class="line">	第三步：软件编译配置过程</span><br><span class="line">	cd nginx-1.16.0/</span><br><span class="line">	useradd www -s /sbin/nologin -M</span><br><span class="line">	./configure  --prefix=/application/nginx-1.16.0  --user=www --group=www --with-http_ssl_module  --with-http_stub_status_module</span><br><span class="line">	--prefix=PATH                      set installation prefix</span><br><span class="line">	                                   指定软件程序安装目录（不需要创建）</span><br><span class="line">	--user=USER                        set non-privileged user for worker processes</span><br><span class="line">	                                   为worker进程设置一个非特权用户（必须存在）</span><br><span class="line">    --group=GROUP                      set non-privileged group for worker processes</span><br><span class="line">	                                   为worker进程设置一个非特权用户组（必须存在）</span><br><span class="line">	--with-http_ssl_module             enable ngx_http_ssl_module</span><br><span class="line">	                                   启用HTTPS功能</span><br><span class="line">	--with-http_stub_status_module     enable ngx_http_stub_status_module</span><br><span class="line">	                                   启动nginx状态监控功能</span><br><span class="line">	第四步：编译过程</span><br><span class="line">	make</span><br><span class="line">	</span><br><span class="line">	第五步：编译安装</span><br><span class="line">	make install</span><br><span class="line">	</span><br><span class="line">	第六步：程序目录创建软链接</span><br><span class="line">	ln -s /application/nginx-1.16.0/ /application/nginx</span><br></pre></td></tr></table></figure>

<h3 id="8-nginx程序目录结构信息"><a href="#8-nginx程序目录结构信息" class="headerlink" title="8.nginx程序目录结构信息"></a>8.nginx程序目录结构信息</h3><p><img src="/images/zong%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/666.jpg.png" alt="666.jpg"></p>
<p> 参见图<br>    /etc/nginx/nginx.conf      — 主配置文件<br>    /etc/nginx/*cgi(通用接口)  — nginx（无法处理动态请求） -fast_cgi- php   </p>
<h3 id="9-nginx程序配置文件说明"><a href="#9-nginx程序配置文件说明" class="headerlink" title="9.nginx程序配置文件说明"></a>9.nginx程序配置文件说明</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">准备工作：</span><br><span class="line">	cp nginx.conf nginx.conf.default</span><br><span class="line">    grep -v &quot;^$&quot; nginx.conf.default &gt;nginx.conf</span><br><span class="line">    /etc/nginx/nginx.conf 	</span><br><span class="line">	user  nginx;                                   --- 指定worker进程管理用户</span><br><span class="line">    worker_processes  1;                           --- 指定worker进程的数量    建议调整数量=服务器CPU核心数（2倍）</span><br><span class="line">    error_log  /var/log/nginx/error.log warn;      --- 指定错误日志保存路径</span><br><span class="line">    pid        /var/run/nginx.pid;                 --- 指定程序pid文件保存路径</span><br><span class="line">    events &#123;</span><br><span class="line">        worker_connections  1024;                  --- worker进程连接数 调整按照2的倍数  服务总的连接数=worker_processes*worker_connections&lt;系统打开文件数</span><br><span class="line">    &#125;</span><br><span class="line">    http &#123;</span><br><span class="line">        include       /etc/nginx/mime.types;       --- 加载指定其它配置文件（媒体资源类型文件）</span><br><span class="line">        default_type  application/octet-stream;    --- 默认识别媒体类型</span><br><span class="line">        log_format  main &apos;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &apos;</span><br><span class="line">                          &apos;$status $body_bytes_sent &quot;$http_referer&quot; &apos;</span><br><span class="line">                          &apos;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&apos;;</span><br><span class="line">						                           --- 定义访问日志的格式信息</span><br><span class="line">        access_log  /var/log/nginx/access.log  ;   --- 定义访问日志存储路径</span><br><span class="line">        sendfile        on;                        --- 和nginx优化有关</span><br><span class="line">        #tcp_nopush     on;                        --- 和nginx优化有关</span><br><span class="line">        keepalive_timeout  65;                     --- 连接超时时间  默认单位秒</span><br><span class="line">        #gzip  on;                                 --- 和nginx优化有关</span><br><span class="line">        include /etc/nginx/conf.d/*.conf;          --- 加载conf.d下面的所有.conf扩展配置文件</span><br><span class="line">    &#125;</span><br><span class="line">	</span><br><span class="line">	疑问解答：</span><br><span class="line">	01. nginx程序worker进程是什么？</span><br><span class="line">	    master process：控制服务可以正常运行  老板</span><br><span class="line">		worker process：处理用户访问请求      员工</span><br><span class="line">	02. nginx配置文件结构：</span><br><span class="line">	    1）核心配置部分     main   区域 </span><br><span class="line">        2）事件配置部分     event  区域	</span><br><span class="line">        3）网站配置部分     http   区域     指定网站功能参数</span><br><span class="line">        4）主机配置区域     server 区域 	指定每个网站信息（域名 站点目录 首页文件）</span><br><span class="line">        5）location配置区域                 指定网站特殊功能</span><br></pre></td></tr></table></figure>

<p>主机配置文件配置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">准备工作： </span><br><span class="line">	grep  -Ev &quot;^$|#&quot; default.conf &gt;www.conf</span><br><span class="line">	/etc/nginx/conf.d/www.conf</span><br><span class="line">    server &#123;</span><br><span class="line">        listen       80;                    --- 指定服务监听信息  默认监听端口信息</span><br><span class="line">        server_name  www.gurenyun.com;        --- 指定网站域名信息</span><br><span class="line">        location / &#123;                        --- 匹配不同uri，进行不同的配置 ？？？</span><br><span class="line">            root   /usr/share/nginx/html;   --- 指定站点目录路径</span><br><span class="line">            index  index.html index.htm;    --- 指定首页文件信息</span><br><span class="line">        &#125;</span><br><span class="line">        error_page   500 502 503 504  /gurenyun,jpg;   --- 优雅显示错误信息</span><br><span class="line">        location = /gurenyun.jpg &#123;                     --- 匹配指定50x.html的uri</span><br><span class="line">            root   /html;                            --- 指定站点目录</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">更改优雅显示错误页面：</span><br><span class="line">    实践配置：</span><br><span class="line">    #vim www.conf </span><br><span class="line">    server &#123;</span><br><span class="line">        listen       80;</span><br><span class="line">        server_name  www.gurenyun.com;</span><br><span class="line">        location / &#123;</span><br><span class="line">            root   /usr/share/nginx/html;</span><br><span class="line">            index  index.html index.htm;</span><br><span class="line">        &#125;</span><br><span class="line">        error_page   404 500 502 503 504  /gurenyun.jpg;</span><br><span class="line">        location = /gurenyun.jpg &#123;</span><br><span class="line">            root   /html;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">	</span><br><span class="line">	创建目录和数据信息：</span><br><span class="line">	mkdir /html  --- 放入gurenyun.jpg图片</span><br><span class="line">	</span><br><span class="line">	本地域名解析：</span><br><span class="line">	C:\Windows\System32\drivers\etc\hosts</span><br></pre></td></tr></table></figure>

<h3 id="10-nginx程序企业应用方法："><a href="#10-nginx程序企业应用方法：" class="headerlink" title="10.nginx程序企业应用方法："></a>10.nginx程序企业应用方法：</h3><h4 id="1-如何搭建多个网站-www-bbs-blog"><a href="#1-如何搭建多个网站-www-bbs-blog" class="headerlink" title="1) 如何搭建多个网站  www bbs blog"></a>1) 如何搭建多个网站  www bbs blog</h4><p>第一个历程：创建多个网站主机文件:</p>
<p>cd /etc/nginx/conf.d/</p>
<p>cp <a href="http://www.conf" target="_blank" rel="noopener">www.conf</a>  bbs.conf </p>
<p>cp <a href="http://www.conf" target="_blank" rel="noopener">www.conf</a> blog.conf</p>
<p>更改配置文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[root@web01 conf.d]# cat www.conf bbs.conf blog.conf </span><br><span class="line">       server &#123;</span><br><span class="line">           listen       80;</span><br><span class="line">           server_name  www.gurenyun.com;</span><br><span class="line">           location / &#123;</span><br><span class="line">               root   /html/www;</span><br><span class="line">               index  index.html index.htm;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       server &#123;</span><br><span class="line">           listen       80;</span><br><span class="line">           server_name  bbs.gurenyun.com;</span><br><span class="line">           location / &#123;</span><br><span class="line">               root   /html/bbs;</span><br><span class="line">               index  index.html index.htm;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       server &#123;</span><br><span class="line">           listen       80;</span><br><span class="line">           server_name  blog.gurenyun.com;</span><br><span class="line">           location / &#123;</span><br><span class="line">               root   /html/blog;</span><br><span class="line">               index  index.html index.htm;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>

<p>第二个历程：创建不同网站站点目录/创建网站页面信息index.html </p>
<p>[root@web01 conf.d]# for name in {www,bbs,blog};do echo “$name.gurenyun.com” &gt;/html/$name/index.html;done</p>
<p> [root@web01 conf.d]# for name in {www,bbs,blog};do cat /html/$name/index.html;done<br>       <a href="http://www.gurenyun.com" target="_blank" rel="noopener">www.gurenyun.com</a><br>       bbs.gurenyun.com<br>       blog.gurenyun.com</p>
<p><img src="/images/zong%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/a2d19f5b73d622a5ed8178ad8abf9ee.png" alt="a2d19f5b73d622a5ed8178ad8abf9ee"></p>
<p>第三个历程：配置DNS解析信息</p>
<p>hosts文件中加入解析信息：</p>
<p>10.0.0.7  <a href="http://www.gurenyun.com" target="_blank" rel="noopener">www.gurenyun.com</a>  bbs.gurenyun.com blog.gurenyun.com</p>
<p>第四个历程：重启nginx程序</p>
<p>​     方法一：使用systemctl命令重启nginx程序</p>
<p>​     systemctl restart/reload nginx</p>
<p>​      方法二：利用nginx命令重启nginx程序</p>
<p>​       nginx<br>​       nginx -s reload<br>​       nginx -t 检查配置文件语法<br>​                如何确认语法没问题<br>​                1-每个指令参数编写正确/位置放置正确<br>​                2-每个区域信息需要有一对花括号<br>​                3-每个指令参数最后有分号结尾<br>​       PS：以上两种方式不要混用</p>
<h4 id="2）如何访问网站页面"><a href="#2）如何访问网站页面" class="headerlink" title="2）如何访问网站页面"></a>2）如何访问网站页面</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">基于端口访问</span><br><span class="line">	   server &#123;</span><br><span class="line">           listen       8080;    --- 修改端口号</span><br><span class="line">           server_name  www.gurenyun.com;</span><br><span class="line">           location / &#123;</span><br><span class="line">               root   /html/www;</span><br><span class="line">               index  index.html index.htm;</span><br><span class="line">           &#125;</span><br><span class="line">       </span><br><span class="line">       &#125;</span><br><span class="line">	   </span><br><span class="line">	   访问原理：</span><br><span class="line">	   01. 和指定IP地址建立连接  --- 10.0.0.7</span><br><span class="line">	   02. 向指定端口发出请求    --- 8080</span><br><span class="line">	   03. 找寻匹配80端口的主机信息</span><br><span class="line">	   04. 匹配用户的请求主机信息</span><br><span class="line">	       将配置的第一个主机信息进行显示</span><br><span class="line">	   </span><br><span class="line">	   基于地址访问 </span><br><span class="line">	   [root@web01 conf.d]# cat www.conf </span><br><span class="line">       server &#123; </span><br><span class="line">           listen       172.16.1.7:80;   --- 修改地址信息</span><br><span class="line">           server_name  www.gurenyun.com;</span><br><span class="line">           access_log  /var/log/nginx/access_gurenyun.log  gurenyun;</span><br><span class="line">           location / &#123;</span><br><span class="line">               root   /html/www;</span><br><span class="line">               index  index.html index.htm;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">	   PS：nginx程序涉及到IP地址的修改，都需要重启服务（不是平滑重启）</span><br></pre></td></tr></table></figure>

<h4 id="3-利用nginx显示网站目录索引"><a href="#3-利用nginx显示网站目录索引" class="headerlink" title="3) 利用nginx显示网站目录索引"></a>3) 利用nginx显示网站目录索引</h4><p>第一个历程：将首页文件进行删除</p>
<p>cd /html/www/</p>
<p>mv index.html{,.bck}</p>
<p><img src="/images/zong%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/1561636245384.png" alt="1561636245384"></p>
<p>第二个历程：修改配置文件添加指令，建立目录索引</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">           listen       80;</span><br><span class="line">           server_name  www.gurenyun.com;</span><br><span class="line">           access_log  /var/log/nginx/access_gurenyun.log  gurenyun;</span><br><span class="line">           location / &#123;</span><br><span class="line">               root   /html/www;</span><br><span class="line">               index  index.html index.htm;</span><br><span class="line">               autoindex  on;          --- 当首页文件不存在，会显示站点目录索引结构信息</span><br><span class="line">			   charset    UTF-8;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>

<p><img src="/images/zong%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/1561636462837.png" alt="1561636462837"></p>
<h4 id="4-利用nginx实现安全访问控制"><a href="#4-利用nginx实现安全访问控制" class="headerlink" title="4)利用nginx实现安全访问控制"></a>4)利用nginx实现安全访问控制</h4><h5 id="1-基于用户访问信息进行控制-images-av"><a href="#1-基于用户访问信息进行控制-images-av" class="headerlink" title="1.基于用户访问信息进行控制 /images  /av"></a>1.基于用户访问信息进行控制 /images  /av</h5><p>/images   允许  gurenyun.jpg</p>
<p>/av       禁止  gurenyun.html</p>
<p>第一个历程：部署站点目录环境<br>          mkdir  /html/www/{images,av}</p>
<p>第二个历程：编辑配置文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">              listen       80;</span><br><span class="line">              server_name  www.gurenyun.com;</span><br><span class="line">              access_log  /var/log/nginx/access_gurenyun.log  gurenyun;</span><br><span class="line">			  root   /html/www;   --- 全局配置</span><br><span class="line">              location / &#123;</span><br><span class="line">                  root   /html/www;   --- 局部配置</span><br><span class="line">                  index  index.html index.htm;</span><br><span class="line">              &#125;</span><br><span class="line">              location /images &#123;</span><br><span class="line">                  allow all;</span><br><span class="line">                  root   /html/www;</span><br><span class="line">                  index  gurenyun.jpg index.html index.htm;</span><br><span class="line">              &#125;</span><br><span class="line">              location /av &#123;</span><br><span class="line">                  allow  10.0.0.1;</span><br><span class="line">                  deny all;</span><br><span class="line">                  root   /html/www;</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br></pre></td></tr></table></figure>

<p><img src="/images/zong%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/1561637110944.png" alt="1561637110944"></p>
<h5 id="2）基于用户认证信息进行控制"><a href="#2）基于用户认证信息进行控制" class="headerlink" title="2）基于用户认证信息进行控制"></a>2）基于用户认证信息进行控制</h5><p>第一个历程：创建密码文件信息</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@web01 conf.d]# htpasswd -bc /etc/nginx/nginx.password gurenyun gurenyun123</span><br><span class="line">          Adding password for user gurenyun</span><br><span class="line">          [root@web01 conf.d]# cat /etc/nginx/nginx.password </span><br><span class="line">          gurenyun:$apr1$.RxGBSH0$ePH61Rs8PuAuhv9boxvYz0</span><br></pre></td></tr></table></figure>

<p><img src="/images/zong%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/1561637350549.png" alt="1561637350549"></p>
<p>第二个历程：编写主机配置文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@web01 conf.d]# vim www.conf </span><br><span class="line">          server &#123;</span><br><span class="line">              listen       80;</span><br><span class="line">              server_name  www.gurenyun.com;</span><br><span class="line">              access_log  /var/log/nginx/access_gurenyun.log  gurenyun;</span><br><span class="line">              auth_basic  &quot;gurenyun61&quot;;</span><br><span class="line">              auth_basic_user_file /etc/nginx/nginx.password;</span><br><span class="line">              location / &#123;</span><br><span class="line">                  root   /html/www;</span><br><span class="line">                  index  index.html index.htm;</span><br><span class="line">                  autoindex  on;</span><br><span class="line">                  charset  UTF-8;</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br></pre></td></tr></table></figure>

<p><img src="/images/zong%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/1561637808820.png" alt="1561637808820"></p>
<h4 id="5-利用nginx实现网站状态监控"><a href="#5-利用nginx实现网站状态监控" class="headerlink" title="5) 利用nginx实现网站状态监控"></a>5) 利用nginx实现网站状态监控</h4><p>编写监控网站主机配置文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@web01 conf.d]# cat stat.conf </span><br><span class="line">       server &#123;</span><br><span class="line">           listen       80;</span><br><span class="line">           server_name  stat.gurenyun.com;</span><br><span class="line">           location / &#123;</span><br><span class="line">               stub_status;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>

<p><img src="/images/zong%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/1561638978222.png" alt="1561638978222"></p>
<p>重启nginx后将stat.gurenyun.com 加入 hosts文件中。</p>
<h5 id="页面监控信息："><a href="#页面监控信息：" class="headerlink" title="页面监控信息："></a>页面监控信息：</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Active connections       --- 总的激活并发连接数	</span><br><span class="line">       accepts                  --- 总的接收连接数信息	   </span><br><span class="line">	   handled                  --- 总的处理连接数信息</span><br><span class="line">	   requests                 --- 总的请求数量</span><br><span class="line">	   Reading: 读取请求报文数量   </span><br><span class="line">	   Writing: 回复响应报文数量</span><br><span class="line">	   Waiting: 等待队列</span><br></pre></td></tr></table></figure>

<p><img src="/images/zong%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/1561639771300.png" alt="1561639771300"></p>
<h5 id="取出指定信息进行监控："><a href="#取出指定信息进行监控：" class="headerlink" title="取出指定信息进行监控："></a>取出指定信息进行监控：</h5><p> curl -H host:stat.gurenyun.com 172.16.1.7</p>
<p><img src="/images/zong%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/1561687136829.png" alt="1561687136829"></p>
<p>可以用awk取出指定监控信息</p>
<p>curl -H host:stat.gurenyun.com 172.16.1.7 2&gt;/dev/null|awk ‘NR==3{print $1}’<br>curl -H host:stat.gurenyun.com 172.16.1.7 -s|awk ‘NR==3{print $1}’</p>
<p><img src="/images/zong%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/1561687332348.png" alt="1561687332348"></p>
<h4 id="6）nginx程序日志配置说明"><a href="#6）nginx程序日志配置说明" class="headerlink" title="6）nginx程序日志配置说明"></a>6）nginx程序日志配置说明</h4><h5 id="错误日志：记录服务常见错误"><a href="#错误日志：记录服务常见错误" class="headerlink" title="错误日志：记录服务常见错误"></a>错误日志：记录服务常见错误</h5><p>vim  /etc/nginx/nginx.conf</p>
<p><img src="/images/zong%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/1561689900776.png" alt="1561689900776"></p>
<pre><code>01. 服务运行错误信息</code></pre><ol start="2">
<li><p>用户访问页面的错误</p>
<p><img src="/images/zong%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/1561690080444.png" alt="1561690080444"></p>
</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">错误级别设置：</span><br><span class="line">error_log  /var/log/nginx/error.log warn（记录错误级别）;</span><br><span class="line">	   debug    --- 调试级别    产生的日志信息最多</span><br><span class="line">	   info     --- 信息级别</span><br><span class="line">	   notice   --- 通知级别 </span><br><span class="line">	   warn     --- 警告级别</span><br><span class="line">	   error    --- 错误级别  </span><br><span class="line">	   crit     --- 严重级别</span><br><span class="line">	   alert    --- 非常严重级别</span><br><span class="line">	   emerg    --- 灾难级别    产生的日志信息最少</span><br></pre></td></tr></table></figure>

<h5 id="访问日志：记录用户访问信息"><a href="#访问日志：记录用户访问信息" class="headerlink" title="访问日志：记录用户访问信息"></a>访问日志：记录用户访问信息</h5><ol>
<li>记录用户访问网站什么信息</li>
<li>记录访问访问网站用户信息</li>
</ol>
<p><img src="/images/zong%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/1561689369125.png" alt="1561689369125"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"> nginx默认变量：</span><br><span class="line">$remote_addr：    --- 访问网站客户端源IP地址</span><br><span class="line">	   $remote_user      --- 表示认证用户名称信息</span><br><span class="line">	   [$time_local]     --- 显示响应时间信息</span><br><span class="line">	   $request          --- 显示请求行信息</span><br><span class="line">	   $status           --- 显示状态码</span><br><span class="line">	   $body_bytes_sent  --- 回复数据大小（流量）信息 字节</span><br><span class="line">	   $http_referer     --- 盗链人地址信息/用于推广</span><br><span class="line">	   $http_user_agent  --- 显示用户访问网站客户端程序 （电脑 手机）</span><br></pre></td></tr></table></figure>

<h3 id="11-nginx程序区域模块-location"><a href="#11-nginx程序区域模块-location" class="headerlink" title="11.nginx程序区域模块 - location"></a>11.nginx程序区域模块 - location</h3><p> 功能：匹配不同的uri信息，做出相应处理<br>    Syntax:    location [ = | ~ | <del>* | ^</del> ] uri { … }       语法结构<br>                           匹配          uri  执行什么动作<br>            awk       ‘模式{动作}’<br>    Default:    —<br>    Context：server, location   — 可以配置在什么区域中<br>    =:        精确匹配                 = /gurenyun   <a href="http://www.gurenyun.com" target="_blank" rel="noopener">www.gurenyun.com</a>  /gurenyun<br>    <del>:        模糊匹配（区分大小写）<br>    ~*：    模糊匹配（不区分大小写）<br>    ^</del>:     优先匹配 不识别uri信息中正则符号</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">如何应用                                优先级</span><br><span class="line">location = / &#123;                          01</span><br><span class="line">       return  301;</span><br><span class="line">   &#125;</span><br><span class="line">   </span><br><span class="line">   location / &#123;                          05   默认匹配</span><br><span class="line">       return  302;</span><br><span class="line">   &#125;</span><br><span class="line">   </span><br><span class="line">   location /documents/ &#123;                04</span><br><span class="line">       return  404;</span><br><span class="line">   &#125;</span><br><span class="line">   </span><br><span class="line">   location ^~ /images/ &#123;                02</span><br><span class="line">       return  502;</span><br><span class="line">   &#125;</span><br><span class="line">   </span><br><span class="line">   location ~* \.(gif|jpg|jpeg)$ &#123;       03</span><br><span class="line">       return  520;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>  样例：测试 ~ 和 ~*<br>    location ~ /test/ {<br>        return  301;<br>    }<br>    location ~* /test/ {<br>        return  302;<br>    }</p>
<p><img src="/images/zong%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/1561788997663.png" alt="1561788997663"></p>
<p><img src="/images/zong%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/1561789053237.png" alt="1561789053237"></p>
<p>规范站点目录结构信息：<br>    [root@web01 conf.d]# cat <a href="http://www.conf" target="_blank" rel="noopener">www.conf</a><br>    server {<br>        listen       80;<br>        server_name  <a href="http://www.gurenyun.com" target="_blank" rel="noopener">www.gurenyun.com</a>;<br>        location ~* .jpg$ {<br>            root  /html/www/jpg;<br>        }<br>        location ~* .png$ {<br>            root /html/www/png;<br>        }<br>        location / {<br>            root  /html;<br>            index index.html;<br>        }<br>    }</p>
<h3 id="12-nginx程序重写功能说明-rewrite"><a href="#12-nginx程序重写功能说明-rewrite" class="headerlink" title="12.nginx程序重写功能说明  rewrite"></a>12.nginx程序重写功能说明  rewrite</h3><p> Syntax:     rewrite regex          replacement   [flag];<br>                    正则信息匹配   修改成的信息   标记<br>    Default: —<br>    Context: server, location（推荐）, if</p>
<p>​    last：      跳转完毕，会在执行其他动作<br>​    break：     跳转完毕，不在执行其他动作<br>​    redirect    302  临时跳转   *****<br>​    permanent： 301  永久跳转 </p>
<h4 id="1）-跳转配置中last与break区别对比示例"><a href="#1）-跳转配置中last与break区别对比示例" class="headerlink" title="1）. 跳转配置中last与break区别对比示例"></a>1）. 跳转配置中last与break区别对比示例</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">   listen            80;</span><br><span class="line">   server_name       www.gurenyun.com;</span><br><span class="line">   root              /html;</span><br><span class="line">   location  ~ ^/break/ &#123;</span><br><span class="line">       rewrite  ^/break/  /test/  break;</span><br><span class="line">   &#125;</span><br><span class="line">   location  ~ ^/last/  &#123;</span><br><span class="line">       rewrite  ^/last/  /test/  last;</span><br><span class="line">   &#125;</span><br><span class="line">   location   /test/ &#123;</span><br><span class="line">       default_type   application/json;</span><br><span class="line">       return 200 &apos;ok&apos;;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/images/zong%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/1561790532353.png" alt="1561790532353"></p>
<p><img src="/images/zong%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/1561790560131.png" alt="1561790560131"></p>
<h4 id="2）-临时跳转和永久跳转配置"><a href="#2）-临时跳转和永久跳转配置" class="headerlink" title="2） 临时跳转和永久跳转配置"></a>2） 临时跳转和永久跳转配置</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">	   listen            80;</span><br><span class="line">	   server_name       www.gurenyun.com;</span><br><span class="line">	   root              /html;</span><br><span class="line">	   location  ~ ^/gurenyun &#123;</span><br><span class="line">	       rewrite  ^(.*)$  https://www.etiantian.org redirect;</span><br><span class="line">		   rewrite  ^(.*)$  https://www.etiantian.org permanent;</span><br><span class="line">	       # return 301 http://bbs.etiantian.org;</span><br><span class="line">		   # return 302 http://bbs.etiantian.org;</span><br><span class="line">	   &#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p> 永久跳转记录跳转信息：  301<br>临时跳转不记录跳转信息：302</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">301永久： 用户浏览器  -请求信息-&gt;  www.360buy.com --&gt; 301 --&gt; www.jd.com</span><br><span class="line">	           客户端                              服务端</span><br><span class="line">			  用户浏览器  -请求信息-&gt;  www.360buy.com</span><br><span class="line">			                       -&gt;  www.jd.com     ---&gt; 服务端</span><br><span class="line">	总结：在浏览器上记录跳转的缓存信息</span><br><span class="line">	          www.jd.com/gurenyun.jpg   ---    </span><br><span class="line">	          www.jd.com/2017/    404</span><br><span class="line">	302临时： 用户浏览器  -请求信息-&gt;  www.360buy.com --&gt; 302 --&gt; www.jd.com</span><br><span class="line">	           客户端                              服务端</span><br><span class="line">	          用户浏览器  -请求信息-&gt;  www.360buy.com --&gt; 302 --&gt; www.jjd.com</span><br><span class="line">	           客户端                              服务端</span><br><span class="line">	总结：在浏览器上不记录跳转的缓存信息</span><br><span class="line">	          www.jd.com/gurenyun.jpg   --- www.jd.com/2018/</span><br><span class="line">	</span><br><span class="line">	补充：实现地址跳转的方法</span><br><span class="line">	第一种：利用rewrite  正则匹配</span><br><span class="line">	第二种：利用retrun</span><br></pre></td></tr></table></figure>

<h5 id="练习1）：用户访问-abc-1-html实际上真实访问是-ccc-bbb-2-html"><a href="#练习1）：用户访问-abc-1-html实际上真实访问是-ccc-bbb-2-html" class="headerlink" title="练习1）：用户访问/abc/1.html实际上真实访问是/ccc/bbb/2.html"></a>练习1）：用户访问/abc/1.html实际上真实访问是/ccc/bbb/2.html</h5><p>#<a href="http://www.gurenyun.com/abc/1.html" target="_blank" rel="noopener">http://www.gurenyun.com/abc/1.html</a> ==&gt; <a href="http://www.gurenyun.com/ccc/bbb/2.html" target="_blank" rel="noopener">http://www.gurenyun.com/ccc/bbb/2.html</a><br> 第一里程：准备真实的访问路径</p>
<p>[root@web01 conf.d]# mkdir -p /html/www/ccc/bbb<br>[root@web01 conf.d]# echo ceshi11111111 &gt; /html/www/ccc/bbb/1.html</p>
<p>第二个里程：更改配置文件  Nginx跳转配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@web01 conf.d]# cat www.conf</span><br><span class="line"> server &#123;</span><br><span class="line">	   listen            80;</span><br><span class="line">	   server_name       www.gedage.com;</span><br><span class="line">	   root              /html/www;</span><br><span class="line">           location /abc/ &#123;</span><br><span class="line">              rewrite (.*) /ccc/bbb/1.html redirect;</span><br><span class="line">              #return 302 /ccc/bbb/1.html;</span><br><span class="line">            &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> 第三个里程：重启Nginx服务<br>    [root@web03 ~]# systemctl restart nginx</p>
<h5 id="练习2）：用户访问-2018-ccc-bbb-2-html实际上真实访问是-2019-ccc-bbb-2-html"><a href="#练习2）：用户访问-2018-ccc-bbb-2-html实际上真实访问是-2019-ccc-bbb-2-html" class="headerlink" title="练习2）：用户访问/2018/ccc/bbb/2.html实际上真实访问是/2019/ccc/bbb/2.html"></a>练习2）：用户访问/2018/ccc/bbb/2.html实际上真实访问是/2019/ccc/bbb/2.html</h5><p>#<a href="http://www.gurenyun.com/2018/ccc/bbb/2.html" target="_blank" rel="noopener">http://www.gurenyun.com/2018/ccc/bbb/2.html</a> ==&gt; <a href="http://www.gurenyun.com/2019/ccc/bbb/2.html" target="_blank" rel="noopener">http://www.gurenyun.com/2019/ccc/bbb/2.html</a></p>
<p> 第一个里程：准备真实的访问路径：</p>
<p>[root@web03 ~]# mkdir /html/www/2019/ccc/bbb -p<br>[root@web03 ~]# echo “2019_ccc_bbb_2” &gt; /html/www/2019/ccc/bbb/2.html</p>
<p> 第二个里程：Nginx跳转配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@web01 conf.d]# cat www.conf</span><br><span class="line"> server &#123;</span><br><span class="line">	   listen            80;</span><br><span class="line">	   server_name       www.gedage.com;</span><br><span class="line">	   root              /html/www;</span><br><span class="line">           location /2018 &#123;</span><br><span class="line">              rewrite ^/2018/(.*)$ /2019/$1 redirect;    </span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> 第三个里程：重启Nginx服务<br>    [root@web03 ~]# systemctl restart nginx</p>
<h5 id="练习3）：用户访问course-11-22-33-html实际上真实访问是-course-11-22-33-course-33-html"><a href="#练习3）：用户访问course-11-22-33-html实际上真实访问是-course-11-22-33-course-33-html" class="headerlink" title="练习3）：用户访问course-11-22-33.html实际上真实访问是/course/11/22/33/course_33.html"></a>练习3）：用户访问course-11-22-33.html实际上真实访问是/course/11/22/33/course_33.html</h5><p>​    #<a href="http://www.gurenyun.com/course-11-22-33.html" target="_blank" rel="noopener">http://www.gurenyun.com/course-11-22-33.html</a> ==&gt; <a href="http://www.gurenyun.com/course/11/22/33/course_33.html" target="_blank" rel="noopener">http://www.gurenyun.com/course/11/22/33/course_33.html</a>  </p>
<p>第一个里程 准备真实的访问路径</p>
<p>[root@web03 ~]# mkdir /html/www/course/11/22/33/ -p<br>[root@web03 ~]# echo “docs.etiantian.org” &gt; /html/www/course/11/22/33/course_33.html</p>
<p>第二个里程 Nginx跳转配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@web01 conf.d]# cat www.conf</span><br><span class="line"> server &#123;</span><br><span class="line">	   listen            80;</span><br><span class="line">	   server_name       www.gedage.com;</span><br><span class="line">	   root              /html/www;</span><br><span class="line">           location /course &#123;</span><br><span class="line">              rewrite ^/course-(.*)-(.*)-(.*).html /course/$1/$2/$3/course_33.html redirect;    </span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> 第三个里程：重启Nginx服务<br>    [root@web03 ~]# systemctl restart nginx</p>
<h5 id="终极测验a）："><a href="#终极测验a）：" class="headerlink" title="终极测验a）："></a>终极测验a）：</h5><p>访问gurenyun.com/gurenyun.jpg  —&gt;  <a href="http://www.gurenyun.com/gurenyun.jpg" target="_blank" rel="noopener">www.gurenyun.com/gurenyun.jpg</a>   临时<br>    第一个历程：准备环境<br>    将gurenyun.jpg — 站点目录<br>    第二个历程：编写配置文件：<br>    server {<br>      listen      80;<br>      server_name <a href="http://www.gurenyun.com" target="_blank" rel="noopener">www.gurenyun.com</a>;<br>         root  /html/www;<br>         index index.html;<br>         rewrite ^/(.*)  <a href="http://www.gurenyun.com/$1" target="_blank" rel="noopener">http://www.gurenyun.com/$1</a>  redirect;<br>    }</p>
<pre><code>第一种方式：多个server配置
server { 
listen   80;
server_name  gurenyun.com;
rewrite ^/(.*)  http://www.gurenyun.com/$1  redirect;
}
server {
      listen      80;
      server_name www.gurenyun.com;
      root  /html/www;
      index index.html;
}
第二种方式：打破循环 if 内置变量 
server {
  listen      80;
  server_name www.gurenyun.com;
     root  /html/www;
     index index.html;
     if ($host ~ ^gurenyun.com) { 
        rewrite ^/(.*)  http://www.gurenyun.com/$1  redirect;
     }    
}

 nginx常用内置变量：
    $host                 记录请求报文请求主体的host信息     
    $server_name        当前用户配置server_name的域名信息
    $request_filename   当前请求的文件路径名（带网站的主目录/html/www/images/test.jpg）
    $request_uri        当前请求的文件路径名（不带网站的主目录/images/test.jpg）
    $scheme             用的协议，比如http或者https</code></pre><p>第三个历程：配置DNS解析<br>    10.0.0.7   gurenyun.com  <a href="http://www.gurenyun.com" target="_blank" rel="noopener">www.gurenyun.com</a>    </p>
<h5 id="终极测验b）："><a href="#终极测验b）：" class="headerlink" title="终极测验b）："></a>终极测验b）：</h5><p>访问<a href="http://www.etiantian.org" target="_blank" rel="noopener">www.etiantian.org</a>      —&gt;  <a href="http://www.gurenyun.com" target="_blank" rel="noopener">www.gurenyun.com</a>   永久</p>
<p>第一个历程：准备环境<br>    将gurenyun.jpg — 站点目录</p>
<p>第二个历程：编写配置文件：<br>    server {<br>      listen      80;<br>      server_name <a href="http://www.gurenyun.com" target="_blank" rel="noopener">www.gurenyun.com</a>;<br>         root  /html/www;<br>         index index.html;<br>         if ($host ~ <a href="http://www.etiantian.org" target="_blank" rel="noopener">www.etiantian.org</a>) {<br>            rewrite ^/(.<em>)  <a href="http://www.gurenyun.com/$1" target="_blank" rel="noopener">http://www.gurenyun.com/$1</a>  redirect;<br>         }<br>    }<br>第三个历程：主配置文件编写<br>    include /etc/nginx/conf.d/<a href="http://www.conf" target="_blank" rel="noopener">www.conf</a><br>    include /etc/nginx/conf.d/</em>.conf;<br>第四个历程：配置DNS解析<br>    10.0.0.7   gurenyun.com  <a href="http://www.gurenyun.com" target="_blank" rel="noopener">www.gurenyun.com</a> <a href="http://www.etiantian.org" target="_blank" rel="noopener">www.etiantian.org</a>    </p>
<p>部署LNMP架构</p>
<p>​    L linux系统：  防火墙/selinux关闭  /tmp 1777<br>​    N nginx程序：<br>​    M mysql程序：  mariadb    yum安装<br>​    P php程序：    编译安装   yum安装 7.1<br>​    </p>
<h3 id="13-mariadb安装过程："><a href="#13-mariadb安装过程：" class="headerlink" title="13.mariadb安装过程："></a>13.mariadb安装过程：</h3><p>yum install mariadb-server mariadb -y</p>
<p>php安装过程：</p>
<p>第一个历程：移除其他版本php软件</p>
<p>yum remove php-mysql php php-fpm php-common</p>
<p>第二个历程：更新yum源</p>
<p>rpm -Uvh <a href="https://dl.fedoraproject.org/pub/epel/epel-release-latest-7.noarch.rpm" target="_blank" rel="noopener">https://dl.fedoraproject.org/pub/epel/epel-release-latest-7.noarch.rpm</a><br>rpm -Uvh <a href="https://mirror.webtatic.com/yum/el7/webtatic-release.rpm" target="_blank" rel="noopener">https://mirror.webtatic.com/yum/el7/webtatic-release.rpm</a></p>
<p>第三个历程：yum安装</p>
<p>yum install -y php71w php71w-cli php71w-common php71w-devel php71w-embedded  php71w-gd php71w-mcrypt php71w-mbstring php71w-pdo php71w-xml php71w-fpm php71w-mysqlnd php71w-opcache  php71w-pecl-memcached php71w-pecl-redis php71w-pecl-mongodb</p>
</debug>
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/架构/" rel="tag"># 架构</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/08/27/quan全网备份步骤/" rel="next" title="全网备份步骤">
                <i class="fa fa-chevron-left"></i> 全网备份步骤
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/08/27/fang防火墙/" rel="prev" title="防火墙">
                防火墙 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/head.jpg" alt="葛任远">
            
              <p class="site-author-name" itemprop="name">葛任远</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">7</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">2</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">7</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#架构完善部分："><span class="nav-number">1.</span> <span class="nav-text">架构完善部分：</span></a></li></ol><li class="nav-item nav-level-2"><a class="nav-link" href="#二、虚拟机架构规划"><span class="nav-number"></span> <span class="nav-text">二、虚拟机架构规划</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-虚拟机的配置"><span class="nav-number">1.</span> <span class="nav-text">1.虚拟机的配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-主机（模板机）系统优化"><span class="nav-number">2.</span> <span class="nav-text">2.主机（模板机）系统优化</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-虚拟主机（模板机）网络配置"><span class="nav-number">3.</span> <span class="nav-text">3.虚拟主机（模板机）网络配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-虚拟主机的克隆操作"><span class="nav-number">4.</span> <span class="nav-text">4.虚拟主机的克隆操作</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#三、综合架构备份服务"><span class="nav-number"></span> <span class="nav-text">三、综合架构备份服务</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ps-作用"><span class="nav-number">1.</span> <span class="nav-text">ps:作用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-如何实现备份服务部署–rsync"><span class="nav-number">2.</span> <span class="nav-text">1.如何实现备份服务部署–rsync</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-rsync命令详细用法说明"><span class="nav-number">3.</span> <span class="nav-text">2.rsync命令详细用法说明</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-rsync守护进程的部署过程"><span class="nav-number">4.</span> <span class="nav-text">3.rsync守护进程的部署过程</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#服务端部署流程："><span class="nav-number">4.1.</span> <span class="nav-text">服务端部署流程：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#客户端部署流程："><span class="nav-number">4.2.</span> <span class="nav-text">客户端部署流程：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#配置文件："><span class="nav-number">4.3.</span> <span class="nav-text">配置文件：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#配置文件解析："><span class="nav-number">4.4.</span> <span class="nav-text">配置文件解析：</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-Rsync服务常见问题汇总讲解："><span class="nav-number">5.</span> <span class="nav-text">4.Rsync服务常见问题汇总讲解：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-rsync命令参数说明"><span class="nav-number">6.</span> <span class="nav-text">5.rsync命令参数说明</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-rsync守护进程企业应用"><span class="nav-number">7.</span> <span class="nav-text">5.rsync守护进程企业应用</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1）守护进程多模块功能配置"><span class="nav-number">7.1.</span> <span class="nav-text">1）守护进程多模块功能配置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2）守护进程的排除功能实践"><span class="nav-number">7.2.</span> <span class="nav-text">2）守护进程的排除功能实践</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-守护进程来创建备份目录（全网备份项目）"><span class="nav-number">7.3.</span> <span class="nav-text">3) 守护进程来创建备份目录（全网备份项目）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-守护进程的访问控制配置"><span class="nav-number">7.4.</span> <span class="nav-text">4) 守护进程的访问控制配置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5）守护进程无差异同步配置"><span class="nav-number">7.5.</span> <span class="nav-text">5）守护进程无差异同步配置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6）守护进程的列表功能配置"><span class="nav-number">7.6.</span> <span class="nav-text">6）守护进程的列表功能配置</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-备份服务优缺点"><span class="nav-number">8.</span> <span class="nav-text">6.备份服务优缺点</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#服务配置文件被移动到其他路径，如何启动服务"><span class="nav-number">8.1.</span> <span class="nav-text">服务配置文件被移动到其他路径，如何启动服务</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#四、综合架构存储服务器"><span class="nav-number"></span> <span class="nav-text">四、综合架构存储服务器</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-存储服务器概念介绍"><span class="nav-number">1.</span> <span class="nav-text">1.存储服务器概念介绍</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-NFS存储服务器架构中作用"><span class="nav-number">2.</span> <span class="nav-text">2.NFS存储服务器架构中作用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-NFS服务安装部署"><span class="nav-number">3.</span> <span class="nav-text">3.NFS服务安装部署</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#服务端部署："><span class="nav-number">3.1.</span> <span class="nav-text">服务端部署：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#客户端部署："><span class="nav-number">3.2.</span> <span class="nav-text">客户端部署：</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-nfs配置文件参数说明"><span class="nav-number">4.</span> <span class="nav-text">4. nfs配置文件参数说明</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-企业中：如何进行配置"><span class="nav-number">5.</span> <span class="nav-text">5.企业中：如何进行配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-NFS服务程序常见的问题总结"><span class="nav-number">6.</span> <span class="nav-text">6.NFS服务程序常见的问题总结</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-存储服务重要文件-命令总结"><span class="nav-number">7.</span> <span class="nav-text">7.存储服务重要文件/命令总结</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-客户端如何实现自动挂载"><span class="nav-number">8.</span> <span class="nav-text">8.客户端如何实现自动挂载</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-客户端挂载参数说明："><span class="nav-number">9.</span> <span class="nav-text">9.客户端挂载参数说明：</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#五、综合架构远程连接（SSH）"><span class="nav-number"></span> <span class="nav-text">五、综合架构远程连接（SSH）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-远程连接服务概念介绍"><span class="nav-number">1.</span> <span class="nav-text">1.远程连接服务概念介绍</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-远程连接服务连接原理"><span class="nav-number">2.</span> <span class="nav-text">2.远程连接服务连接原理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-远程连接通讯建立方式"><span class="nav-number">3.</span> <span class="nav-text">3.远程连接通讯建立方式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-基于密钥方式实现远程连接步骤："><span class="nav-number">4.</span> <span class="nav-text">4.基于密钥方式实现远程连接步骤：</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#管理端服务器"><span class="nav-number">4.1.</span> <span class="nav-text">管理端服务器</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1-创建密钥对信息"><span class="nav-number">4.1.1.</span> <span class="nav-text">1.创建密钥对信息</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-分发公钥"><span class="nav-number">4.1.2.</span> <span class="nav-text">2.分发公钥</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3-检查确认"><span class="nav-number">4.1.3.</span> <span class="nav-text">3.检查确认</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#被管理端服务器"><span class="nav-number">4.2.</span> <span class="nav-text">被管理端服务器</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1-检查确认"><span class="nav-number">4.2.1.</span> <span class="nav-text">1.检查确认</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-解决免交互问题："><span class="nav-number">4.2.2.</span> <span class="nav-text">2.解决免交互问题：</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3-远程服务端口号发生变化了，如何修改脚本命令"><span class="nav-number">4.2.3.</span> <span class="nav-text">3. 远程服务端口号发生变化了，如何修改脚本命令</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#4-SSH服务端配置文件说明："><span class="nav-number">4.2.4.</span> <span class="nav-text">4. SSH服务端配置文件说明：</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#5-SSH防范远程入侵方案"><span class="nav-number">4.2.5.</span> <span class="nav-text">5.SSH防范远程入侵方案</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-远程服务相关命令"><span class="nav-number">5.</span> <span class="nav-text">5.远程服务相关命令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-服务概述"><span class="nav-number">6.</span> <span class="nav-text">1.服务概述</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-ansible软件学习方法"><span class="nav-number">7.</span> <span class="nav-text">2.ansible软件学习方法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-ansible软件安装部署"><span class="nav-number">8.</span> <span class="nav-text">3.ansible软件安装部署</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#测试ansible连接失败，排错思路："><span class="nav-number">8.1.</span> <span class="nav-text">测试ansible连接失败，排错思路：</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-ansible软件配置应用"><span class="nav-number">9.</span> <span class="nav-text">4.ansible软件配置应用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-主机清单如何配置："><span class="nav-number">10.</span> <span class="nav-text">5.主机清单如何配置：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-批量管理模块使用方法"><span class="nav-number">11.</span> <span class="nav-text">6.批量管理模块使用方法</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#补充：ansible输出信息有颜色显示："><span class="nav-number">11.1.</span> <span class="nav-text">补充：ansible输出信息有颜色显示：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#第一个模块：命令模块-command（默认）"><span class="nav-number">11.2.</span> <span class="nav-text">第一个模块：命令模块 - command（默认）</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#特殊用法：chdir-参数"><span class="nav-number">11.2.1.</span> <span class="nav-text">特殊用法：chdir 参数</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#特殊用法：creates-参数"><span class="nav-number">11.2.2.</span> <span class="nav-text">特殊用法：creates 参数</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#特殊用法：removes-参数"><span class="nav-number">11.2.3.</span> <span class="nav-text">特殊用法：removes 参数</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#第二个模块：命令模块-shell（万能模块）"><span class="nav-number">11.3.</span> <span class="nav-text">第二个模块：命令模块 - shell（万能模块）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#第三个模块：命令模块-script-（执行脚本）、"><span class="nav-number">11.4.</span> <span class="nav-text">第三个模块：命令模块 - script （执行脚本）、</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#第四个模块：文件模块-copy-（批量分发文件—推）"><span class="nav-number">11.5.</span> <span class="nav-text">第四个模块：文件模块 - copy （批量分发文件—推）</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#特殊用法：传输文件时，修改文件权限"><span class="nav-number">11.5.1.</span> <span class="nav-text">特殊用法：传输文件时，修改文件权限</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#特殊用法：分发文件时，对源文件进行备份"><span class="nav-number">11.5.2.</span> <span class="nav-text">特殊用法：分发文件时，对源文件进行备份</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#特殊用法：远程主机文件进行复制备份（便于批量还原）"><span class="nav-number">11.5.3.</span> <span class="nav-text">特殊用法：远程主机文件进行复制备份（便于批量还原）</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#第五个模块：文件模块-fetch-（批量拉取文件—拉）-扩展"><span class="nav-number">11.6.</span> <span class="nav-text">第五个模块：文件模块 - fetch  （批量拉取文件—拉） 扩展</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#第六个模块：文件模型-file-（修改文件权限-）"><span class="nav-number">11.7.</span> <span class="nav-text">第六个模块：文件模型 - file （修改文件权限 ）</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#用法：修改文件权限"><span class="nav-number">11.7.1.</span> <span class="nav-text">用法：修改文件权限</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#特殊用法：创建文件-touch"><span class="nav-number">11.7.2.</span> <span class="nav-text">特殊用法：创建文件 touch</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#特殊用法：创建目录-directory"><span class="nav-number">11.7.3.</span> <span class="nav-text">特殊用法：创建目录 directory</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#特殊用法：创建硬链接-hard"><span class="nav-number">11.7.4.</span> <span class="nav-text">特殊用法：创建硬链接 hard</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#特殊用法：创建软链接-ink"><span class="nav-number">11.7.5.</span> <span class="nav-text">特殊用法：创建软链接 ink</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#特殊用法：删除文件数据-absent"><span class="nav-number">11.7.6.</span> <span class="nav-text">特殊用法：删除文件数据 absent</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#第七个模块：-cron-定时任务模块"><span class="nav-number">11.8.</span> <span class="nav-text">第七个模块： cron 定时任务模块</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#第八个模块：yum-批量下载安装软件"><span class="nav-number">11.9.</span> <span class="nav-text">第八个模块：yum 批量下载安装软件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#第九个模块：service-管理服务状态模块"><span class="nav-number">11.10.</span> <span class="nav-text">第九个模块：service 管理服务状态模块</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#第九个模块：user-用户管理模块"><span class="nav-number">11.11.</span> <span class="nav-text">第九个模块：user  用户管理模块</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#第十个模块：mount-挂载模块"><span class="nav-number">11.12.</span> <span class="nav-text">第十个模块：mount  挂载模块</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#六、利用剧本功能完成服务程序一键化部署"><span class="nav-number"></span> <span class="nav-text">六、利用剧本功能完成服务程序一键化部署</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-编写脚本："><span class="nav-number">0.1.</span> <span class="nav-text">1.编写脚本：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-编写剧本"><span class="nav-number">0.2.</span> <span class="nav-text">2.编写剧本</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#剧本内容编写："><span class="nav-number">0.2.1.</span> <span class="nav-text">剧本内容编写：</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#剧本执行方法："><span class="nav-number">0.2.2.</span> <span class="nav-text">剧本执行方法：</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#常见问题："><span class="nav-number">0.2.3.</span> <span class="nav-text">常见问题：</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-一键化剧本编写"><span class="nav-number">0.3.</span> <span class="nav-text">3.一键化剧本编写</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#八、数据实时同步备份"><span class="nav-number"></span> <span class="nav-text">八、数据实时同步备份</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-概念说明："><span class="nav-number">1.</span> <span class="nav-text">1.概念说明：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-同步原理："><span class="nav-number">2.</span> <span class="nav-text">2.同步原理：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-实时监控软件inotify"><span class="nav-number">3.</span> <span class="nav-text">3.实时监控软件inotify</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-inotifywait参数说明："><span class="nav-number">3.1.</span> <span class="nav-text">1)inotifywait参数说明：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-inotify事件信息："><span class="nav-number">3.2.</span> <span class="nav-text">2)inotify事件信息：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-实践操作演示："><span class="nav-number">3.3.</span> <span class="nav-text">3) 实践操作演示：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-脚本如何实现实时同步："><span class="nav-number">3.4.</span> <span class="nav-text">4)脚本如何实现实时同步：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-停止脚本"><span class="nav-number">3.5.</span> <span class="nav-text">5)停止脚本</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6）-inotify服务优化说明"><span class="nav-number">3.6.</span> <span class="nav-text">6） inotify服务优化说明</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-实现实时同步：sersync软件"><span class="nav-number">4.</span> <span class="nav-text">4.实现实时同步：sersync软件</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1）sersync软件下载安装"><span class="nav-number">4.1.</span> <span class="nav-text">1）sersync软件下载安装</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2）编写sersync服务配置文件"><span class="nav-number">4.2.</span> <span class="nav-text">2）编写sersync服务配置文件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3）sersync服务如何启动"><span class="nav-number">4.3.</span> <span class="nav-text">3）sersync服务如何启动</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-配置lsync服务"><span class="nav-number">5.</span> <span class="nav-text">5.配置lsync服务</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#九、综合架构网站服务原理"><span class="nav-number"></span> <span class="nav-text">九、综合架构网站服务原理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-用户访问网站的原理过程："><span class="nav-number">1.</span> <span class="nav-text">1.用户访问网站的原理过程：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-用户访问网站HTTP协议原理"><span class="nav-number">2.</span> <span class="nav-text">2.用户访问网站HTTP协议原理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-HTTP协议资源"><span class="nav-number">3.</span> <span class="nav-text">3.HTTP协议资源</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-网站度量方式：面试题"><span class="nav-number">4.</span> <span class="nav-text">4.网站度量方式：面试题</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-企业网站常见web服务"><span class="nav-number">5.</span> <span class="nav-text">5.企业网站常见web服务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-nginx程序功能介绍"><span class="nav-number">6.</span> <span class="nav-text">6.nginx程序功能介绍</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-nginx软件部署安装过程"><span class="nav-number">7.</span> <span class="nav-text">7.nginx软件部署安装过程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-nginx程序目录结构信息"><span class="nav-number">8.</span> <span class="nav-text">8.nginx程序目录结构信息</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-nginx程序配置文件说明"><span class="nav-number">9.</span> <span class="nav-text">9.nginx程序配置文件说明</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#10-nginx程序企业应用方法："><span class="nav-number">10.</span> <span class="nav-text">10.nginx程序企业应用方法：</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-如何搭建多个网站-www-bbs-blog"><span class="nav-number">10.1.</span> <span class="nav-text">1) 如何搭建多个网站  www bbs blog</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2）如何访问网站页面"><span class="nav-number">10.2.</span> <span class="nav-text">2）如何访问网站页面</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-利用nginx显示网站目录索引"><span class="nav-number">10.3.</span> <span class="nav-text">3) 利用nginx显示网站目录索引</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-利用nginx实现安全访问控制"><span class="nav-number">10.4.</span> <span class="nav-text">4)利用nginx实现安全访问控制</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1-基于用户访问信息进行控制-images-av"><span class="nav-number">10.4.1.</span> <span class="nav-text">1.基于用户访问信息进行控制 /images  /av</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2）基于用户认证信息进行控制"><span class="nav-number">10.4.2.</span> <span class="nav-text">2）基于用户认证信息进行控制</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-利用nginx实现网站状态监控"><span class="nav-number">10.5.</span> <span class="nav-text">5) 利用nginx实现网站状态监控</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#页面监控信息："><span class="nav-number">10.5.1.</span> <span class="nav-text">页面监控信息：</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#取出指定信息进行监控："><span class="nav-number">10.5.2.</span> <span class="nav-text">取出指定信息进行监控：</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6）nginx程序日志配置说明"><span class="nav-number">10.6.</span> <span class="nav-text">6）nginx程序日志配置说明</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#错误日志：记录服务常见错误"><span class="nav-number">10.6.1.</span> <span class="nav-text">错误日志：记录服务常见错误</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#访问日志：记录用户访问信息"><span class="nav-number">10.6.2.</span> <span class="nav-text">访问日志：记录用户访问信息</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#11-nginx程序区域模块-location"><span class="nav-number">11.</span> <span class="nav-text">11.nginx程序区域模块 - location</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#12-nginx程序重写功能说明-rewrite"><span class="nav-number">12.</span> <span class="nav-text">12.nginx程序重写功能说明  rewrite</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1）-跳转配置中last与break区别对比示例"><span class="nav-number">12.1.</span> <span class="nav-text">1）. 跳转配置中last与break区别对比示例</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2）-临时跳转和永久跳转配置"><span class="nav-number">12.2.</span> <span class="nav-text">2） 临时跳转和永久跳转配置</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#练习1）：用户访问-abc-1-html实际上真实访问是-ccc-bbb-2-html"><span class="nav-number">12.2.1.</span> <span class="nav-text">练习1）：用户访问/abc/1.html实际上真实访问是/ccc/bbb/2.html</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#练习2）：用户访问-2018-ccc-bbb-2-html实际上真实访问是-2019-ccc-bbb-2-html"><span class="nav-number">12.2.2.</span> <span class="nav-text">练习2）：用户访问/2018/ccc/bbb/2.html实际上真实访问是/2019/ccc/bbb/2.html</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#练习3）：用户访问course-11-22-33-html实际上真实访问是-course-11-22-33-course-33-html"><span class="nav-number">12.2.3.</span> <span class="nav-text">练习3）：用户访问course-11-22-33.html实际上真实访问是/course/11/22/33/course_33.html</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#终极测验a）："><span class="nav-number">12.2.4.</span> <span class="nav-text">终极测验a）：</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#终极测验b）："><span class="nav-number">12.2.5.</span> <span class="nav-text">终极测验b）：</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#13-mariadb安装过程："><span class="nav-number">13.</span> <span class="nav-text">13.mariadb安装过程：</span></a></li></ol></li></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">葛任远</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Gemini</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  

  

</body>
</html>
